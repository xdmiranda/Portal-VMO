<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manuten√ß√£o de viaturas ‚Äî Portal VMO</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="script.js" defer></script>

  <!-- Estilo local (s√≥ desta p√°gina) para n√£o mexer no styles.css -->
  <style>
    .mv-wrap { display: flex; flex-direction: column; gap: 16px; }
    .mv-subtitle { margin-top: 6px; color: #666; }

    .mv-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .mv-kpi {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      border-left: 6px solid #f2c200;
      padding: 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 72px;
    }
    .mv-kpi .label { font-size: 12px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: .3px; }
    .mv-kpi .value { font-size: 26px; font-weight: 800; color: #222; line-height: 1; }
    .mv-kpi .hint { font-size: 12px; color: #777; }
    .mv-kpi.ok { border-left-color: #2ecc71; }
    .mv-kpi.warn { border-left-color: #f39c12; }
    .mv-kpi.danger { border-left-color: #e74c3c; }
    .mv-kpi.neutral { border-left-color: #95a5a6; }

    /* Toolbar: Equipe + Data in√≠cio + Data fim + Criticidade + Tipo + Status + Limpar */
    .mv-toolbar{
      display: grid;
      grid-template-columns: 1fr 1.6fr 1fr 1fr 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: end;
      margin-top: 6px;
    }

    .mv-field label{
      display: block;
      font-size: 12px;
      color: #666;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .mv-field input, .mv-field select, .mv-field textarea{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid #e4e4e4;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
    }
    .mv-field textarea{
      min-height: 92px;
      resize: vertical;
      line-height: 1.4;
    }

    .mv-actions{
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .mv-btn{
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 800;
      background: #f2c200;
      color: #222;
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      transition: transform .2s ease, opacity .2s ease;
      white-space: nowrap;
    }
    .mv-btn:hover{ transform: translateY(-1px); opacity: .95; }
    .mv-btn.secondary{
      background: #f3f3f3;
      color: #222;
    }

    .mv-note{
      background: #fff7d1;
      border: 1px solid rgba(242, 194, 0, .35);
      padding: 10px 12px;
      border-radius: 12px;
      color: #444;
      font-size: 13px;
      line-height: 1.35;
    }

    .mv-table-wrap{
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      overflow: hidden;
      border: 1px solid #eee;
    }
    table.mv-table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .mv-table thead th{
      text-align: left;
      padding: 12px 12px;
      background: #fafafa;
      border-bottom: 1px solid #eee;
      color: #333;
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .mv-table tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
      color: #333;
    }
    .mv-table tbody tr:hover{
      background: rgba(242, 194, 0, 0.08);
    }

    
.badge{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 12px;
  border: 1px solid #e4e4e4;
  white-space: nowrap;
  background: #f3f3f3;
  color: #333;
}
.badge.ok, .badge.warn, .badge.danger, .badge.neutral{
  background: #f3f3f3;
  color: #333;
  border-color: #e4e4e4;
}
    .mv-more{
      display: inline-block;
      font-weight: 800;
      color: #1f1f1f;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 6px;
      font-size: 12px;
    }

    .mv-empty{
      padding: 16px;
      color: #666;
      font-size: 13px;
    }

    /* Criticidade (seletor colorido) */
    .crit-select{
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #e4e4e4;
      font-weight: 900;
      outline: none;
      background: #fff;
      cursor: pointer;
      appearance: none;
    }
    .crit-select.baixa{
      background: rgba(46,204,113,.12);
      border-color: rgba(46,204,113,.25);
      color: #1f7a43;
    }
    .crit-select.media{
      background: rgba(243,156,18,.14);
      border-color: rgba(243,156,18,.28);
      color: #8a5a00;
    }
    .crit-select.alta{
      background: rgba(231,76,60,.12);
      border-color: rgba(231,76,60,.25);
      color: #8c2b22;
    }

    @media (max-width: 980px){
      .mv-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .mv-toolbar{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .mv-grid { grid-template-columns: 1fr; }
      .mv-toolbar{ grid-template-columns: 1fr; }
      .mv-actions{ justify-content: stretch; }
      .mv-btn{ width: 100%; }
    }
  

/* ===============================
   Modal / Quadro flutuante (Detalhes)
================================ */
.mv-modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 18px;
}
.mv-modal-overlay.open{ display: flex; }

.mv-modal{
  width: min(720px, 100%);
  max-height: min(78vh, 820px);
  overflow: auto;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 22px 60px rgba(0,0,0,0.28);
  border: 1px solid rgba(0,0,0,0.06);
  position: relative;
}

.mv-modal-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 14px 16px;
  border-bottom: 1px solid #eee;
  background: #fafafa;
  position: sticky;
  top: 0;
  z-index: 1;
}

.mv-modal-title{
  margin: 0;
  font-size: 14px;
  font-weight: 900;
  color: #222;
  letter-spacing: .2px;
}

.mv-modal-close{
  appearance: none;
  border: 1px solid rgba(0,0,0,0.14);
  background: #fff;
  width: 38px;
  height: 38px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 20px;
  line-height: 1;
  display: grid;
  place-items: center;
  transition: transform .15s ease, opacity .15s ease;
}
.mv-modal-close:hover{ transform: scale(1.03); opacity: .95; }

.mv-modal-body{ padding: 14px 16px 18px; }

.mv-details-grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}

.mv-detail{
  background: #fff;
  border: 1px solid #eee;
  border-radius: 12px;
  padding: 12px 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.04);
}

.mv-detail-label{
  font-size: 11px;
  color: #666;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .3px;
  margin-bottom: 6px;
}

.mv-detail-value{
  font-size: 14px;
  color: #222;
  font-weight: 700;
  line-height: 1.35;
  word-break: break-word;
  white-space: pre-wrap;
}

.mv-details-btn{
  appearance: none;
  border: 1px solid rgba(0,0,0,0.14);
  background: #fff;
  color: #222;
  border-radius: 10px;
  padding: 8px 10px;
  font-weight: 900;
  cursor: pointer;
  transition: transform .15s ease, background .15s ease, opacity .15s ease;
  box-shadow: 0 8px 18px rgba(0,0,0,0.06);
}
.mv-details-btn:hover{ transform: translateY(-1px); background: #fafafa; opacity: .98; }
.mv-details-btn:disabled{ opacity: .55; cursor: not-allowed; transform: none; }



</style>
</head>

<body>
  <!-- Topbar (mesma pegada do seu portal) -->
  <header class="topbar">
    <div class="left-section">
      <div class="hamburger" id="menuToggle" role="button" tabindex="0" aria-controls="navMenu" aria-expanded="false">‚ò∞</div>
      <div class="brand">
        <!-- Loader no lugar do logo -->
        <div class="brand-loader-container" aria-hidden="true">
          <div class="loader">
            <div class="truckWrapper">
              <div class="truckBody">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 198 93" class="trucksvg">
                  <path stroke-width="3" stroke="#282828" fill="#F83D3D"
                    d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z"></path>
                  <path stroke-width="3" stroke="#282828" fill="#7D7C7C"
                    d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z"></path>
                  <path stroke-width="2" stroke="#282828" fill="#282828"
                    d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z"></path>
                  <rect stroke-width="2" stroke="#282828" fill="#FFFCAB" rx="1" height="7" width="5" y="63" x="187"></rect>
                  <rect stroke-width="2" stroke="#282828" fill="#282828" rx="1" height="11" width="4" y="81" x="193"></rect>
                  <rect stroke-width="3" stroke="#282828" fill="#DFDFDF" rx="2.5" height="90" width="121" y="1.5" x="6.5"></rect>
                  <rect stroke-width="2" stroke="#282828" fill="#DFDFDF" rx="2" height="4" width="6" y="84" x="1"></rect>
                </svg>
              </div>
              <div class="truckTires">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                  <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                  <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                  <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                  <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                </svg>
              </div>
              <div class="road"></div>
              <svg xml:space="preserve" viewBox="0 0 453.459 453.459"
                xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"
                id="Capa_1" version="1.1" fill="#000000" class="lampPost">
                <path d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993
c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514
c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16
c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914
h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066
c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75v-11.202
c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066
c0-5.068-4.107-9.177-9.176-9.177h-0.795V196.641c0-43.174,14.942-54.283,30.762-66.043
c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0z
M232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514
c0-5.531,1.078-10.957,3.141-16.017h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"></path>
              </svg>
            </div>
          </div>
        </div>
        <span class="brand-name">Portal VMO</span>
      </div>
    </div>

    <div class="right-section">
      <div class="icons"><span>üìù</span><span>‚òëÔ∏è</span><span>üîç</span></div>
      <div class="divider"></div>
      <div class="user-info">
        <strong>ANDREI CERQUEIRA DE MIRANDA</strong>
        <span>VMO ‚Äî Gest√£o / Global TDI</span>
      </div>
      <div class="divider"></div>
      <div class="region"><span>üåé Brasil</span><span>pt-BR ‚ñæ</span><span>‚èª</span></div>
    </div>
  </header>

  <!-- Menu lateral (mesmo padr√£o) -->
  <div class="nav-overlay" id="navOverlay"></div>
  <nav class="nav" id="navMenu" aria-label="Menu do Portal">
    <a href="index.html">In√≠cio</a>
    <a href="relatorios.html">Relat√≥rios Di√°rios</a>
    <a href="neo.html">Confirma√ß√µes Neo Energia</a>
    <a href="ecomp.html">Confirma√ß√µes Ecomp</a>
    <a href="km.html">Controle de KM</a>
    <a href="orientacoes.html">Orienta√ß√µes da √°rea</a>
    <a href="pops.html">POPS</a>
    <a href="ocorrencias.html">Ocorr√™ncias</a>
    <a href="matriz-controle-mensal.html">Matriz de controle mensal</a>
    <a href="manutencao-veiculos.html">Manuten√ß√£o de ve√≠culos</a>
  </nav>

  <!-- Conte√∫do -->
  <main class="content-page">
    <div class="mv-wrap">
      <a href="index.html" class="back-btn">‚Üê Voltar</a>

      <div>
        <h1 style="margin:0;">Manuten√ß√£o de viaturas</h1>
        <p class="mv-subtitle">
          Vis√£o r√°pida do status, filtros e tabela para acompanhamento (objetivo e f√°cil de manter).
        </p>
      </div>

      <!-- Resumo -->
      <div class="mv-grid" aria-label="Resumo">
        <div class="mv-kpi neutral">
          <div class="label">Total de registros</div>
          <div class="value" id="kpiTotal">45</div>
          <div class="hint">Soma geral do controle</div>
        </div>
        <div class="mv-kpi ok">
          <div class="label">Tratadas (TRUE)</div>
          <div class="value" id="kpiTrue">22</div>
          <div class="hint">J√° tratadas/atendidas</div>
        </div>
        <div class="mv-kpi danger">
          <div class="label">N√£o tratadas (FALSE)</div>
          <div class="value" id="kpiFalse">19</div>
          <div class="hint">Aten√ß√£o / precisa a√ß√£o</div>
        </div>
        <div class="mv-kpi warn">
          <div class="label">Pendentes</div>
          <div class="value" id="kpiPendentes">4</div>
          <div class="hint">Em andamento / aguardando</div>
        </div>
      </div>
<!-- Filtros -->
      <div class="mv-toolbar">
        <div class="mv-field">
          <label for="filterCliente">Cliente</label>
          <select id="filterCliente">
          <option value="">Todos</option>
        </select>
        </div>

        <div class="mv-field">
          <label for="filterEquipe">Equipe</label>
          <select id="filterEquipe">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="mv-field">
          <label for="filterDateStart">Data in√≠cio</label>
          <input id="filterDateStart" type="date" />
        </div>

        <div class="mv-field">
          <label for="filterDateEnd">Data fim</label>
          <input id="filterDateEnd" type="date" />
        </div>

        <div class="mv-field">
          <label for="filterCriticidade">Criticidade</label>
          <select id="filterCriticidade">
            <option value="">Todas</option>
            <option value="baixa">Baixa</option>
            <option value="media">M√©dia</option>
            <option value="alta">Alta</option>
          </select>
        </div>

        <div class="mv-field">
          <label for="filterTipo">Tipo</label>
          <select id="filterTipo">
            <option value="">Todos</option>
            <option value="carro">Carro</option>
            <option value="suv">SUV</option>
            <option value="pickup">Pickup</option>
          </select>
        </div>

        <div class="mv-field">
          <label for="filterStatus">Status</label>
          <select id="filterStatus">
            <option value="">Todos</option>
            <option value="pendente">Pendente</option>
            <option value="tratado">Tratado</option>
            <option value="nao_tratado">N√£o tratado</option>
          </select>
        </div>

        <div class="mv-actions">
          <button class="mv-btn secondary" id="btnLimpar">Limpar filtros</button>
        </div>
      </div>
<div class="mv-actions">
<button class="mv-btn secondary" id="btnExemplo">Carregar exemplo</button>
 <button class="mv-btn secondary" id="btnBaixarRelatorio">Baixar Relat√≥rio</button>
      </div>

      <!-- Tabela -->
      <div class="mv-table-wrap" role="region" aria-label="Tabela de manuten√ß√£o">
        <table class="mv-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Equipe</th>
              <th>Data</th>
              <th>Placa</th>
              <th>Tipo</th>
              <th>Criticidade</th>
              <th>Status</th>
              <th>Observa√ß√µes</th>
            </tr>
          </thead>
          <tbody id="mvTbody">
            <tr>
              <td colspan="8" class="mv-empty">
                Nenhum registro carregado ainda. Clique <strong>Carregar exemplo</strong> para visualizar dados.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </main>

  

  <!-- Modal (Quadro flutuante) de detalhes -->
  <div class="mv-modal-overlay" id="mvModalOverlay" aria-hidden="true">
    <div class="mv-modal" role="dialog" aria-modal="true" aria-labelledby="mvModalTitle">
      <div class="mv-modal-header">
        <h3 class="mv-modal-title" id="mvModalTitle">Detalhes da manuten√ß√£o</h3>
        <button type="button" class="mv-modal-close" id="mvModalClose" aria-label="Fechar">√ó</button>
      </div>
      <div class="mv-modal-body" id="mvModalBody"></div>
    </div>
  </div>
<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script>window.jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : undefined;</script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@5.0.7/dist/jspdf.plugin.autotable.min.js"></script>
<!-- JS local s√≥ desta p√°gina: render tabela + filtros + contadores + criticidade -->
  <script>
// Dataset da p√°gina
let mvData = [];
let mvLastRendered = [];

const el = (id) => document.getElementById(id);
const tbody = el('mvTbody');

// filtros
const filterCliente = el('filterCliente');
const filterEquipe = el('filterEquipe');
const filterDateStart = el('filterDateStart');
const filterDateEnd = el('filterDateEnd');
const filterCriticidade = el('filterCriticidade');
const filterTipo = el('filterTipo');
const filterStatus = el('filterStatus');

function normalize(s){
  return (s || '').toString().trim().toLowerCase();
}

function escapeHtml(str){
  return (str || '').toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// ============================== 
// Cliente (fallback)
// ============================== 
function inferClienteFromEquipe(equipe){
  const e = (equipe || '').toString().toUpperCase();
  if (e.includes('ISACTEEP')) return 'ISACTEEP';
  if (e.includes('TBG')) return 'TBG';
  if (e.includes('QUEPAR')) return 'QUEPAR';
  if (e.includes('TELEF')) return 'VIVO';
  if (e.includes('GLP')) return 'GLP';
  if (e.includes('TAI')) return 'TAI ENGENHARIA';
  return '';
}

function getCliente(row){
  return (row && row.cliente) ? row.cliente : inferClienteFromEquipe(row?.equipe);
}

// ============================== 
// Modal (Detalhes)
// ============================== 
let lastFocusedEl = null;

function getModalEls(){
  return {
    overlay: el('mvModalOverlay'),
    closeBtn: el('mvModalClose'),
    body: el('mvModalBody')
  };
}

function openDetailsModal(row){
  const { overlay, closeBtn, body } = getModalEls();
  if (!overlay || !body) return;

  lastFocusedEl = document.activeElement;

  const status = getStatusTag(row);
  const crit = getCriticidade(row);

  const fields = [
    { label: 'Cliente', value: getCliente(row) || '‚Äî' },
    { label: 'Equipe', value: row.equipe || '‚Äî' },
    { label: 'Data', value: row.data || '‚Äî' },
    { label: 'Placa', value: row.placa || '‚Äî' },
    { label: 'Tipo', value: row.tipo || '‚Äî' },
    { label: 'Criticidade', value: (crit === 'alta' ? 'Alta' : (crit === 'media' ? 'M√©dia' : (crit === 'baixa' ? 'Baixa' : '‚Äî'))) },
    { label: 'Status', value: status.text || '‚Äî' },
    { label: 'Tratado', value: (normalize(row.tratado) === 'true' ? 'TRUE' : (normalize(row.tratado) === 'false' ? 'FALSE' : '‚Äî')) },
    { label: 'Observa√ß√µes', value: row.observacoes || '‚Äî' }
  ];

  body.innerHTML = `
    <div class="mv-details-grid">
      ${fields.map(f => `
        <div class="mv-detail">
          <div class="mv-detail-label">${escapeHtml(f.label)}</div>
          <div class="mv-detail-value">${escapeHtml(f.value)}</div>
        </div>
      `).join('')}
    </div>
  `;

  overlay.classList.add('open');
  overlay.setAttribute('aria-hidden', 'false');
  document.body.style.overflow = 'hidden';
  if (closeBtn) closeBtn.focus();
}

function closeDetailsModal(){
  const { overlay } = getModalEls();
  if (!overlay) return;
  overlay.classList.remove('open');
  overlay.setAttribute('aria-hidden', 'true');
  document.body.style.overflow = '';
  if (lastFocusedEl && typeof lastFocusedEl.focus === 'function') lastFocusedEl.focus();
}

document.addEventListener('click', (e) => {
  const detailsBtn = e.target.closest('button.mv-details-btn[data-details="1"]');
  if (detailsBtn) {
    const idx = Number(detailsBtn.getAttribute('data-row'));
    if (!Number.isNaN(idx) && mvLastRendered && mvLastRendered[idx]) openDetailsModal(mvLastRendered[idx]);
    return;
  }

  if (e.target && e.target.id === 'mvModalClose') {
    closeDetailsModal();
    return;
  }

  const overlay = el('mvModalOverlay');
  if (overlay && e.target === overlay) closeDetailsModal();
});

document.addEventListener('keydown', (e) => {
  const overlay = el('mvModalOverlay');
  if (e.key === 'Escape' && overlay && overlay.classList.contains('open')) closeDetailsModal();
});

// ============================== 
// Criticidade (persist√™ncia)
// ============================== 
const CRIT_KEY = 'portal_vmo_manutencao_criticidade_v1';

function rowKey(row){
  return encodeURIComponent(`${row.equipe || ''}|${row.data || ''}|${row.placa || ''}|${row.tipo || ''}`);
}

function loadCritMap(){
  try {
    return JSON.parse(localStorage.getItem(CRIT_KEY) || '{}');
  } catch (e) {
    return {};
  }
}

function saveCritMap(map){
  localStorage.setItem(CRIT_KEY, JSON.stringify(map));
}

function getCriticidade(row){
  const map = loadCritMap();
  const key = rowKey(row);
  const stored = map[key];
  const base = normalize(row.criticidade);
  return stored || (base ? base : 'media');
}

function setCriticidade(row, value){
  const map = loadCritMap();
  map[rowKey(row)] = value;
  saveCritMap(map);
}

// ============================== 
// Data helpers
// ============================== 
function parseAnyDate(value){
  const s = (value || '').toString().trim();
  if (!s) return null;

  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m - 1, d);
  }

  const parts = s.split(' ');
  const datePart = parts[0] || '';
  const timePart = parts[1] || '';

  let dd, mm, yyyy;
  if (datePart.includes('-')) [dd, mm, yyyy] = datePart.split('-').map(Number);
  else if (datePart.includes('/')) [dd, mm, yyyy] = datePart.split('/').map(Number);
  else return null;

  if (!dd || !mm || !yyyy) return null;

  let hh = 0, min = 0;
  if (timePart.includes(':')) {
    const [h, m] = timePart.split(':').map(Number);
    hh = Number.isFinite(h) ? h : 0;
    min = Number.isFinite(m) ? m : 0;
  }

  return new Date(yyyy, mm - 1, dd, hh, min, 0, 0);
}

function inDateRange(rowDate, startISO, endISO){
  if (!startISO && !endISO) return true;
  if (!rowDate) return false;
  const start = startISO ? parseAnyDate(startISO) : null;
  const end = endISO ? parseAnyDate(endISO) : null;
  if (end) end.setHours(23, 59, 59, 999);
  if (start && rowDate < start) return false;
  if (end && rowDate > end) return false;
  return true;
}

// ============================== 
// Status
// ============================== 
function getStatusTag(row){
  const tratado = normalize(row.tratado);
  const pend = normalize(row.status) === 'pendente';
  if (pend) return { text: 'Pendente', cls: 'warn' };
  if (tratado === 'true') return { text: 'Tratado', cls: 'ok' };
  if (tratado === 'false') return { text: 'N√£o tratado', cls: 'danger' };
  return { text: '‚Äî', cls: 'neutral' };
}

// ============================== 
// Popula filtros
// ============================== 
function populateClienteFilter(){
  const current = normalize(filterCliente.value);
  const clientes = [...new Set(mvData.map(r => (getCliente(r) || '').toString().trim()).filter(Boolean))]
    .sort((a,b) => a.localeCompare(b, 'pt-BR'));

  filterCliente.innerHTML = '<option value="">Todos</option>';
  clientes.forEach(c => {
    const opt = document.createElement('option');
    opt.value = normalize(c);
    opt.textContent = c;
    filterCliente.appendChild(opt);
  });

  if (current && clientes.some(c => normalize(c) === current)) filterCliente.value = current;
  else filterCliente.value = '';
}

function populateEquipeFilter(){
  const current = normalize(filterEquipe.value);
  const equipes = [...new Set(mvData.map(r => (r.equipe || '').toString().trim()).filter(Boolean))]
    .sort((a,b) => a.localeCompare(b, 'pt-BR'));

  filterEquipe.innerHTML = '<option value="">Todas</option>';
  equipes.forEach(eq => {
    const opt = document.createElement('option');
    opt.value = normalize(eq);
    opt.textContent = eq;
    filterEquipe.appendChild(opt);
  });

  if (current && equipes.some(eq => normalize(eq) === current)) filterEquipe.value = current;
  else filterEquipe.value = '';
}

// ============================== 
// Render
// ============================== 
function renderTable(list){
  mvLastRendered = list;
  tbody.innerHTML = '';

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="mv-empty">Nenhum registro encontrado com os filtros atuais.</td></tr>';
    return;
  }

  list.forEach((row, i) => {
    const status = getStatusTag(row);
    const tipo = row.tipo || '‚Äî';
    const crit = getCriticidade(row);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(getCliente(row) || '‚Äî')}</td>
      <td>${escapeHtml(row.equipe || '‚Äî')}</td>
      <td>${escapeHtml(row.data || '‚Äî')}</td>
      <td><strong>${escapeHtml(row.placa || '‚Äî')}</strong></td>
      <td>${escapeHtml(tipo)}</td>
      <td>
        <select class="crit-select ${crit}" data-crit="1" aria-label="Selecionar criticidade">
          <option value="baixa" ${crit === 'baixa' ? 'selected' : ''}>Baixa</option>
          <option value="media" ${crit === 'media' ? 'selected' : ''}>M√©dia</option>
          <option value="alta" ${crit === 'alta' ? 'selected' : ''}>Alta</option>
        </select>
      </td>
      <td><span class="badge ${status.cls}">${status.text}</span></td>
      <td>
        <button type="button" class="mv-details-btn" data-details="1" data-row="${i}">Ver detalhes</button>
      </td>
    `;

    const select = tr.querySelector('select[data-crit="1"]');
    select.addEventListener('change', () => {
      const val = normalize(select.value);
      setCriticidade(row, val);
      select.classList.remove('baixa','media','alta');
      select.classList.add(val);
      applyFilters();
    });

    tbody.appendChild(tr);
  });
}

function updateKpis(all){
  const total = all.length;
  const tratados = all.filter(r => normalize(r.tratado) === 'true').length;
  const naoTratados = all.filter(r => normalize(r.tratado) === 'false').length;
  const pendentes = all.filter(r => normalize(r.status) === 'pendente').length;

  el('kpiTotal').textContent = total;
  el('kpiTrue').textContent = tratados;
  el('kpiFalse').textContent = naoTratados;
  el('kpiPendentes').textContent = pendentes;
}

// ============================== 
// Filtros
// ============================== 
function applyFilters(){
  const cli = normalize(filterCliente.value);
  const eq = normalize(filterEquipe.value);
  const ds = filterDateStart.value;
  const de = filterDateEnd.value;
  const cr = normalize(filterCriticidade.value);
  const tipo = normalize(filterTipo.value);
  const st = normalize(filterStatus.value);

  const filtered = mvData.filter(row => {
    const rowCliente = normalize(getCliente(row));
    if (cli && rowCliente !== cli) return false;

    if (eq && normalize(row.equipe) !== eq) return false;

    const rowDate = parseAnyDate(row.data);
    if (!inDateRange(rowDate, ds, de)) return false;

    if (cr) {
      const rowCrit = getCriticidade(row);
      if (rowCrit !== cr) return false;
    }

    if (tipo && normalize(row.tipo) !== tipo) return false;

    if (st) {
      const tratado = normalize(row.tratado);
      const pendente = normalize(row.status) === 'pendente';
      if (st === 'pendente' && !pendente) return false;
      if (st === 'tratado' && tratado !== 'true') return false;
      if (st === 'nao_tratado' && tratado !== 'false') return false;
    }

    return true;
  });

  renderTable(filtered);
  updateKpis(mvData);
}

// ============================== 
// PDF - Baixar Relat√≥rio (jsPDF + AutoTable) + KPIs
// ============================== 
function formatNow(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}

function getSelectedText(sel, fallback){
  if (!sel) return fallback || '';
  const opt = sel.options && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex] : null;
  return opt ? (opt.textContent || sel.value || fallback || '') : (sel.value || fallback || '');
}

function getFiltroResumo(){
  const cliTxt = filterCliente.value ? getSelectedText(filterCliente, 'Todos') : 'Todos';
  const eqTxt = filterEquipe.value ? getSelectedText(filterEquipe, 'Todas') : 'Todas';
  const ds = filterDateStart.value || '‚Äî';
  const de = filterDateEnd.value || '‚Äî';
  const crTxt = filterCriticidade.value ? getSelectedText(filterCriticidade, 'Todas') : 'Todas';
  const tipoTxt = filterTipo.value ? getSelectedText(filterTipo, 'Todos') : 'Todos';
  const stTxt = filterStatus.value ? getSelectedText(filterStatus, 'Todos') : 'Todos';
  return { cliTxt, eqTxt, ds, de, crTxt, tipoTxt, stTxt };
}

function getKpisFromTela(){
  const num = (id) => {
    const node = el(id);
    const v = node ? (node.textContent || '').trim() : '0';
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  };
  return {
    total: num('kpiTotal'),
    tratadas: num('kpiTrue'),
    naoTratada: num('kpiFalse'),
    pendentes: num('kpiPendentes')
  };
}

function drawKpiCards(doc, x0, y0, pageWidth){
  const gap = 6;
  const cardW = (pageWidth - x0*2 - gap*3) / 4;
  const cardH = 22;
  const k = getKpisFromTela();

  const cards = [
    { label: 'TOTAL DE REGISTROS', value: String(k.total), hint: 'Soma geral do controle', bar: [149, 165, 166] },
    { label: 'TRATADAS (TRUE)', value: String(k.tratadas), hint: 'J√° tratadas/atendidas', bar: [46, 204, 113] },
    { label: 'N√ÉO TRATADAS (FALSE)', value: String(k.naoTratada), hint: 'Aten√ß√£o / precisa a√ß√£o', bar: [231, 76, 60] },
    { label: 'PENDENTES', value: String(k.pendentes), hint: 'Em andamento / aguardando', bar: [243, 156, 18] }
  ];

  for (let i = 0; i < cards.length; i++){
    const c = cards[i];
    const x = x0 + i * (cardW + gap);

    doc.setDrawColor(230);
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(x, y0, cardW, cardH, 3, 3, 'FD');

    doc.setFillColor(c.bar[0], c.bar[1], c.bar[2]);
    doc.roundedRect(x, y0, 2.6, cardH, 2, 2, 'F');

    doc.setTextColor(90);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(c.label, x + 6, y0 + 7);

    doc.setTextColor(20);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text(c.value, x + 6, y0 + 15);

    doc.setTextColor(120);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.text(c.hint, x + 6, y0 + 20);
  }

  return y0 + cardH;
}

function gerarPdfRelatorio(){
  if (!window.jsPDF) {
    alert('Biblioteca jsPDF n√£o carregou. Verifique sua conex√£o e tente novamente.');
    return;
  }

  const rows = Array.isArray(mvLastRendered) ? mvLastRendered : [];
  if (!rows.length) {
    alert('Sem registros vis√≠veis para gerar o relat√≥rio.');
    return;
  }

  const doc = new window.jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
  if (typeof doc.autoTable !== 'function') {
    alert('Plugin AutoTable n√£o carregou. Verifique sua conex√£o e tente novamente.');
    return;
  }

  const { cliTxt, eqTxt, ds, de, crTxt, tipoTxt, stTxt } = getFiltroResumo();
  const titulo = 'Relat√≥rio - Manuten√ß√£o de viaturas';
  const geradoEm = new Date().toLocaleString('pt-BR');
  const pageWidth = doc.internal.pageSize.getWidth();

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(14);
  doc.setTextColor(20);
  doc.text(titulo, 14, 14);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.setTextColor(60);
  doc.text(`Gerado em: ${geradoEm}`, 14, 20);
  doc.text(`Filtros: Cliente: ${cliTxt} ‚Ä¢ Equipe: ${eqTxt} ‚Ä¢ Data: ${ds} at√© ${de} ‚Ä¢ Criticidade: ${crTxt} ‚Ä¢ Tipo: ${tipoTxt} ‚Ä¢ Status: ${stTxt}`, 14, 26);
  doc.text(`Total vis√≠vel (tabela): ${rows.length}`, 14, 32);

  const cardsBottom = drawKpiCards(doc, 14, 36, pageWidth);

  const head = [[ 'Cliente', 'Equipe', 'Data', 'Placa', 'Tipo', 'Criticidade', 'Status', 'Observa√ß√µes' ]];
  const body = rows.map(r => {
    const crit = getCriticidade(r);
    const critTxt = (crit === 'alta') ? 'Alta' : (crit === 'media' ? 'M√©dia' : (crit === 'baixa' ? 'Baixa' : '‚Äî'));
    const status = getStatusTag(r);
    return [
      (getCliente(r) || '‚Äî').toString(),
      (r.equipe || '‚Äî').toString(),
      (r.data || '‚Äî').toString(),
      (r.placa || '‚Äî').toString(),
      (r.tipo || '‚Äî').toString(),
      critTxt,
      (status.text || '‚Äî').toString(),
      (r.observacoes || '‚Äî').toString()
    ];
  });

  doc.autoTable({
    head,
    body,
    startY: cardsBottom + 6,
    styles: { font: 'helvetica', fontSize: 8, cellPadding: 2, valign: 'top' },
    headStyles: { fillColor: [243, 243, 243], textColor: [34, 34, 34], fontStyle: 'bold' },
    columnStyles: {
      0: { cellWidth: 24 },
      1: { cellWidth: 50 },
      2: { cellWidth: 22 },
      3: { cellWidth: 18 },
      4: { cellWidth: 18 },
      5: { cellWidth: 20 },
      6: { cellWidth: 18 },
      7: { cellWidth: 72 }
    },
    didDrawPage: function () {
      const pageCount = doc.getNumberOfPages();
      const pageInfo = doc.internal.getCurrentPageInfo();
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(`P√°gina ${pageInfo.pageNumber} de ${pageCount}`, pageW - 34, pageH - 8);
    }
  });

  doc.save(`relatorio_manutencao_viaturas_${formatNow()}.pdf`);
}

// ============================== 
// Eventos
// ============================== 
['input','change'].forEach(evt => {
  filterCliente.addEventListener(evt, applyFilters);
  filterEquipe.addEventListener(evt, applyFilters);
  filterDateStart.addEventListener(evt, applyFilters);
  filterDateEnd.addEventListener(evt, applyFilters);
  filterCriticidade.addEventListener(evt, applyFilters);
  filterTipo.addEventListener(evt, applyFilters);
  filterStatus.addEventListener(evt, applyFilters);
});

el('btnLimpar').addEventListener('click', () => {
  filterCliente.value = '';
  filterEquipe.value = '';
  filterDateStart.value = '';
  filterDateEnd.value = '';
  filterCriticidade.value = '';
  filterTipo.value = '';
  filterStatus.value = '';
  applyFilters();
});

el('btnExemplo').addEventListener('click', () => {
  mvData = [
{
          "equipe": "VMO - TBG - GUARAREMA",
          "cliente": "TBG",
          "data": "01-02-2026 18:00",
          "placa": "TEW2E60",
          "tipo": "Pickup",
          "observacoes": "Condutor nesta data Diego Peres MT 5704167",
          "tratado": "TRUE",
          "status": "Fianlizado",
          "criticidade": "Baixa"
        },
{
          "equipe": "ISACTEEP SPI - EQUIPE BAIXADA",
          "cliente": "ISACTEEP",
          "data": "01-02-2026 18:00",
          "placa": "TEA3H97",
          "tipo": "Carro",
          "observacoes": "N/A carro apitando",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "media"
        },
{
          "equipe": "EQUIPE VMO - QUEPAR - BAHIA",
          "cliente": "QUEPAR",
          "data": "02-02-2026 10:00",
          "placa": "TDG9F48",
          "tipo": "Carro",
          "observacoes": "Abertura para in√≠cio da ronda da QUEPAR",
          "tratado": "TRUE",
          "status": "Fianalizado",
          "criticidade": "Baixa"
        },
{
          "equipe": "ISACTEEP SPI - EQUIPE 1 CAPAO BONITO",
          "cliente": "ISACTEEP",
          "data": "02-02-2026 18:00",
          "placa": "TEA3H97",
          "tipo": "Carro",
          "observacoes": "Ve√≠culo com  problema  na telemetria",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "media"
        },
{
          "equipe": "Zona Operativa 4 - Telef√¥nica",
          "cliente": "VIVO",
          "data": "02-02-2026 19:00",
          "placa": "TEA3H70",
          "tipo": "Carro",
          "observacoes": "Revisar airbag.\nFarol alto lado esquerdo n√£o funciona",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "media"
        },
{
          "equipe": "ISACTEEP SPI - EQUIPE 4 - CABREUVA",
          "cliente": "ISACTEEP",
          "data": "03-02-2026 06:00",
          "placa": "TEJ6G14",
          "tipo": "Carro",
          "observacoes": "Avaria no parachoque trazeiro",
          "tratado": "TRUE",
          "status": "Fianalizado",
          "criticidade": "Baixa"
        },
{
          "equipe": "ISACTEEP SPI - EQUIPE 1 CAPAO BONITO",
          "cliente": "ISACTEEP",
          "data": "03-02-2026 18:00",
          "placa": "TEA3H97",
          "tipo": "Carro",
          "observacoes": "N/A carro com telemetria apitando sem parar",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "media"
        },
{
          "equipe": "EQUIPE VMO - QUEPAR - BAHIA",
          "cliente": "QUEPAR",
          "data": "04-02-2026 10:00",
          "placa": "TDG9F48",
          "tipo": "Carro",
          "observacoes": "Abertura da agenda para in√≠cio a Ronda da QUEPAR.",
          "tratado": "TRUE",
          "status": "Finalizado",
          "criticidade": "baixa"
        },

{
          "equipe": "VMO - TBG - GUARAREMA",
          "cliente": "TBG",
          "data": "05-02-2026 18:00",
          "placa": "TEW2E60",
          "tipo": "Pickup",
          "observacoes": "Paralamas traseiro com pequeno arranh√£o do lado direito pr√≥ximo ao para-choque.\n\nCondutor nesta data\nDiego Peres MT 5704167",
          "tratado": "TRUE",
          "status": "Fianalizado",
          "criticidade": "Baixa"
        },

{
          "equipe": "ISACTEEP SPI - EQUIPE 4 - CABREUVA",
          "cliente": "ISACTEEP",
          "data": "07-02-2026 06:00",
          "placa": "TEJ6G14",
          "tipo": "Carro",
          "observacoes": "Avaria  no parachoque  traseiro\nL√¢mpada  luz baixa do lado direito  queimada",
          "tratado": "TRUE",
          "status": "Finalizado",
          "criticidade": "media"
        },
{
          "equipe": "ISACTEEP SPI - EQUIPE 1 CAPAO BONITO",
          "cliente": "ISACTEEP",
          "data": "07-02-2026 18:00",
          "placa": "TEA3H97",
          "tipo": "Carro",
          "observacoes": "N/A o carro apitando sem parar\nTelemetria ruim  carro com defeito",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "media"
        },
{
          "equipe": "ISACTEEP SPI - EQUIPE 4 - CABREUVA",
          "cliente": "ISACTEEP",
          "data": "11-02-2026 06:00",
          "placa": "TEJ6G14",
          "tipo": "Carro",
          "observacoes": "avaria no parachoque  trazeiro",
           "tratado": "TRUE",
          "status": "Fianalizado",
          "criticidade": "Baixa"
        },
{
          "equipe": "VMO - TBG - GUARAREMA",
          "cliente": "TBG",
          "data": "11-02-2026 18:00",
          "placa": "TEW2E60",
          "tipo": "Pickup",
          "observacoes": "VTR est√° sem a placa Dianteira",
          "tratado": "TRUE",
          "status": "Finalizado",
          "criticidade": "media"
        },

        

  ];
  populateClienteFilter();
  populateEquipeFilter();
  applyFilters();
});

el('btnBaixarRelatorio').addEventListener('click', gerarPdfRelatorio);

// Inicializa
populateClienteFilter();
populateEquipeFilter();
applyFilters();
</script>
</body>
</html>
