<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manuten√ß√£o de viaturas ‚Äî Portal VMO</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="script.js" defer></script>

  <!-- Estilo local (s√≥ desta p√°gina) para n√£o mexer no styles.css -->
  <style>
    .mv-wrap { display: flex; flex-direction: column; gap: 16px; }
    .mv-subtitle { margin-top: 6px; color: #666; }

    .mv-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .mv-kpi {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      border-left: 6px solid #f2c200;
      padding: 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 72px;
    }
    .mv-kpi .label { font-size: 12px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: .3px; }
    .mv-kpi .value { font-size: 26px; font-weight: 800; color: #222; line-height: 1; }
    .mv-kpi .hint { font-size: 12px; color: #777; }
    .mv-kpi.ok { border-left-color: #2ecc71; }
    .mv-kpi.warn { border-left-color: #f39c12; }
    .mv-kpi.danger { border-left-color: #e74c3c; }
    .mv-kpi.neutral { border-left-color: #95a5a6; }

    /* Toolbar: Equipe + Data in√≠cio + Data fim + Criticidade + Tipo + Status + Limpar */
    .mv-toolbar{
      display: grid;
      grid-template-columns: 1.6fr 1fr 1fr 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: end;
      margin-top: 6px;
    }

    .mv-field label{
      display: block;
      font-size: 12px;
      color: #666;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .mv-field input, .mv-field select, .mv-field textarea{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid #e4e4e4;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
    }
    .mv-field textarea{
      min-height: 92px;
      resize: vertical;
      line-height: 1.4;
    }

    .mv-actions{
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .mv-btn{
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 800;
      background: #f2c200;
      color: #222;
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      transition: transform .2s ease, opacity .2s ease;
      white-space: nowrap;
    }
    .mv-btn:hover{ transform: translateY(-1px); opacity: .95; }
    .mv-btn.secondary{
      background: #f3f3f3;
      color: #222;
    }

    .mv-note{
      background: #fff7d1;
      border: 1px solid rgba(242, 194, 0, .35);
      padding: 10px 12px;
      border-radius: 12px;
      color: #444;
      font-size: 13px;
      line-height: 1.35;
    }

    .mv-table-wrap{
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      overflow: hidden;
      border: 1px solid #eee;
    }
    table.mv-table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .mv-table thead th{
      text-align: left;
      padding: 12px 12px;
      background: #fafafa;
      border-bottom: 1px solid #eee;
      color: #333;
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .mv-table tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
      color: #333;
    }
    .mv-table tbody tr:hover{
      background: rgba(242, 194, 0, 0.08);
    }

    
.badge{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 12px;
  border: 1px solid #e4e4e4;
  white-space: nowrap;
  background: #f3f3f3;
  color: #333;
}
.badge.ok, .badge.warn, .badge.danger, .badge.neutral{
  background: #f3f3f3;
  color: #333;
  border-color: #e4e4e4;
}
*/

    .mv-more{
      display: inline-block;
      font-weight: 800;
      color: #1f1f1f;
      text-decoration: underline;
      cursor: pointer;
      margin-top: 6px;
      font-size: 12px;
    }

    .mv-empty{
      padding: 16px;
      color: #666;
      font-size: 13px;
    }

    /* Criticidade (seletor colorido) */
    .crit-select{
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #e4e4e4;
      font-weight: 900;
      outline: none;
      background: #fff;
      cursor: pointer;
      appearance: none;
    }
    .crit-select.baixa{
      background: rgba(46,204,113,.12);
      border-color: rgba(46,204,113,.25);
      color: #1f7a43;
    }
    .crit-select.media{
      background: rgba(243,156,18,.14);
      border-color: rgba(243,156,18,.28);
      color: #8a5a00;
    }
    .crit-select.alta{
      background: rgba(231,76,60,.12);
      border-color: rgba(231,76,60,.25);
      color: #8c2b22;
    }

    @media (max-width: 980px){
      .mv-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .mv-toolbar{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .mv-grid { grid-template-columns: 1fr; }
      .mv-toolbar{ grid-template-columns: 1fr; }
      .mv-actions{ justify-content: stretch; }
      .mv-btn{ width: 100%; }
    }
  

/* ===============================
   Modal / Quadro flutuante (Detalhes)
================================ */
.mv-modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 18px;
}
.mv-modal-overlay.open{ display: flex; }

.mv-modal{
  width: min(720px, 100%);
  max-height: min(78vh, 820px);
  overflow: auto;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 22px 60px rgba(0,0,0,0.28);
  border: 1px solid rgba(0,0,0,0.06);
  position: relative;
}

.mv-modal-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 14px 16px;
  border-bottom: 1px solid #eee;
  background: #fafafa;
  position: sticky;
  top: 0;
  z-index: 1;
}

.mv-modal-title{
  margin: 0;
  font-size: 14px;
  font-weight: 900;
  color: #222;
  letter-spacing: .2px;
}

.mv-modal-close{
  appearance: none;
  border: 1px solid rgba(0,0,0,0.14);
  background: #fff;
  width: 38px;
  height: 38px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 20px;
  line-height: 1;
  display: grid;
  place-items: center;
  transition: transform .15s ease, opacity .15s ease;
}
.mv-modal-close:hover{ transform: scale(1.03); opacity: .95; }

.mv-modal-body{ padding: 14px 16px 18px; }

.mv-details-grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}

.mv-detail{
  background: #fff;
  border: 1px solid #eee;
  border-radius: 12px;
  padding: 12px 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.04);
}

.mv-detail-label{
  font-size: 11px;
  color: #666;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .3px;
  margin-bottom: 6px;
}

.mv-detail-value{
  font-size: 14px;
  color: #222;
  font-weight: 700;
  line-height: 1.35;
  word-break: break-word;
  white-space: pre-wrap;
}

.mv-details-btn{
  appearance: none;
  border: 1px solid rgba(0,0,0,0.14);
  background: #fff;
  color: #222;
  border-radius: 10px;
  padding: 8px 10px;
  font-weight: 900;
  cursor: pointer;
  transition: transform .15s ease, background .15s ease, opacity .15s ease;
  box-shadow: 0 8px 18px rgba(0,0,0,0.06);
}
.mv-details-btn:hover{ transform: translateY(-1px); background: #fafafa; opacity: .98; }
.mv-details-btn:disabled{ opacity: .55; cursor: not-allowed; transform: none; }



/* √Årea tempor√°ria para gera√ß√£o do PDF (fica fora da tela, mas renderiza) */
.mv-print-area{
  position: fixed;
  left: -3000px; /* fora da tela, mas ainda renderiz√°vel */
  top: 0;
  width: 1122px; /* ~ A4 landscape em px a 96dpi */
  background: #fff;
  color: #222;
  pointer-events: none;
}
.mv-print-area table{
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
}
.mv-print-area th, .mv-print-area td{
  border: 1px solid #ddd;
  padding: 6px;
  vertical-align: top;
}
.mv-print-area th{
  background: #f3f3f3;
  font-weight: 900;
}
.mv-print-area h2{
  margin: 0 0 6px;
  font-size: 16px;
}
.mv-print-area .meta{
  font-size: 11px;
  color: #444;
  margin-bottom: 10px;
  line-height: 1.35;
}
.mv-print-area .meta strong{ font-weight: 900; }

</style>
</head>

<body>
  <!-- Topbar (mesma pegada do seu portal) -->
  <header class="topbar">
    <div class="left-section">
      <div class="hamburger" id="menuToggle" role="button" tabindex="0" aria-controls="navMenu" aria-expanded="false">‚ò∞</div>
      <div class="brand">
        <!-- Loader no lugar do logo -->
        <div class="brand-loader-container" aria-hidden="true">
          <div class="loader">
            <div class="truckWrapper">
              <div class="truckBody">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 198 93" class="trucksvg">
                  <path stroke-width="3" stroke="#282828" fill="#F83D3D"
                    d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z"></path>
                  <path stroke-width="3" stroke="#282828" fill="#7D7C7C"
                    d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z"></path>
                  <path stroke-width="2" stroke="#282828" fill="#282828"
                    d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z"></path>
                  <rect stroke-width="2" stroke="#282828" fill="#FFFCAB" rx="1" height="7" width="5" y="63" x="187"></rect>
                  <rect stroke-width="2" stroke="#282828" fill="#282828" rx="1" height="11" width="4" y="81" x="193"></rect>
                  <rect stroke-width="3" stroke="#282828" fill="#DFDFDF" rx="2.5" height="90" width="121" y="1.5" x="6.5"></rect>
                  <rect stroke-width="2" stroke="#282828" fill="#DFDFDF" rx="2" height="4" width="6" y="84" x="1"></rect>
                </svg>
              </div>
              <div class="truckTires">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                  <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                  <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                  <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                  <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                </svg>
              </div>
              <div class="road"></div>
              <svg xml:space="preserve" viewBox="0 0 453.459 453.459"
                xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"
                id="Capa_1" version="1.1" fill="#000000" class="lampPost">
                <path d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993
c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514
c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16
c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914
h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066
c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75v-11.202
c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066
c0-5.068-4.107-9.177-9.176-9.177h-0.795V196.641c0-43.174,14.942-54.283,30.762-66.043
c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0z
M232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514
c0-5.531,1.078-10.957,3.141-16.017h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"></path>
              </svg>
            </div>
          </div>
        </div>
        <span class="brand-name">Portal VMO</span>
      </div>
    </div>

    <div class="right-section">
      <div class="icons"><span>üìù</span><span>‚òëÔ∏è</span><span>üîç</span></div>
      <div class="divider"></div>
      <div class="user-info">
        <strong>ANDREI CERQUEIRA DE MIRANDA</strong>
        <span>VMO ‚Äî Gest√£o / Global TDI</span>
      </div>
      <div class="divider"></div>
      <div class="region"><span>üåé Brasil</span><span>pt-BR ‚ñæ</span><span>‚èª</span></div>
    </div>
  </header>

  <!-- Menu lateral (mesmo padr√£o) -->
  <div class="nav-overlay" id="navOverlay"></div>
  <nav class="nav" id="navMenu" aria-label="Menu do Portal">
    <a href="index.html">In√≠cio</a>
    <a href="relatorios.html">Relat√≥rios Di√°rios</a>
    <a href="neo.html">Confirma√ß√µes Neo Energia</a>
    <a href="ecomp.html">Confirma√ß√µes Ecomp</a>
    <a href="km.html">Controle de KM</a>
    <a href="orientacoes.html">Orienta√ß√µes da √°rea</a>
    <a href="pops.html">POPS</a>
    <a href="ocorrencias.html">Ocorr√™ncias</a>
    <a href="matriz-controle-mensal.html">Matriz de controle mensal</a>
    <a href="manutencao-veiculos.html">Manuten√ß√£o de ve√≠culos</a>
  </nav>

  <!-- Conte√∫do -->
  <main class="content-page">
    <div class="mv-wrap">
      <a href="index.html" class="back-btn">‚Üê Voltar</a>

      <div>
        <h1 style="margin:0;">Manuten√ß√£o de viaturas</h1>
        <p class="mv-subtitle">
          Vis√£o r√°pida do status, filtros e tabela para acompanhamento (objetivo e f√°cil de manter).
        </p>
      </div>

      <!-- Resumo -->
      <div class="mv-grid" aria-label="Resumo">
        <div class="mv-kpi neutral">
          <div class="label">Total de registros</div>
          <div class="value" id="kpiTotal">45</div>
          <div class="hint">Soma geral do controle</div>
        </div>
        <div class="mv-kpi ok">
          <div class="label">Tratadas (TRUE)</div>
          <div class="value" id="kpiTrue">22</div>
          <div class="hint">J√° tratadas/atendidas</div>
        </div>
        <div class="mv-kpi danger">
          <div class="label">N√£o tratadas (FALSE)</div>
          <div class="value" id="kpiFalse">19</div>
          <div class="hint">Aten√ß√£o / precisa a√ß√£o</div>
        </div>
        <div class="mv-kpi warn">
          <div class="label">Pendentes</div>
          <div class="value" id="kpiPendentes">4</div>
          <div class="hint">Em andamento / aguardando</div>
        </div>
      </div>

      <div class="mv-note">
        üí° <strong>Dica:</strong> voc√™ pode colar aqui os dados direto do Excel (copiar e colar) que a tabela monta automaticamente.
        O ideal √© colar com colunas nesta ordem: <em>Equipe / Data agendamento / Placa / Tipo / Observa√ß√µes / Tratado</em>.
        <br>
        <strong>Criticidade</strong> voc√™ define aqui no site (na tabela) e ela fica salva no navegador.
      </div>

      <!-- Filtros -->
      <div class="mv-toolbar">
        <div class="mv-field">
          <label for="filterEquipe">Equipe</label>
          <select id="filterEquipe">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="mv-field">
          <label for="filterDateStart">Data in√≠cio</label>
          <input id="filterDateStart" type="date" />
        </div>

        <div class="mv-field">
          <label for="filterDateEnd">Data fim</label>
          <input id="filterDateEnd" type="date" />
        </div>

        <div class="mv-field">
          <label for="filterCriticidade">Criticidade</label>
          <select id="filterCriticidade">
            <option value="">Todas</option>
            <option value="baixa">Baixa</option>
            <option value="media">M√©dia</option>
            <option value="alta">Alta</option>
          </select>
        </div>

        <div class="mv-field">
          <label for="filterTipo">Tipo</label>
          <select id="filterTipo">
            <option value="">Todos</option>
            <option value="carro">Carro</option>
            <option value="suv">SUV</option>
            <option value="pickup">Pickup</option>
          </select>
        </div>

        <div class="mv-field">
          <label for="filterStatus">Status</label>
          <select id="filterStatus">
            <option value="">Todos</option>
            <option value="pendente">Pendente</option>
            <option value="tratado">Tratado</option>
            <option value="nao_tratado">N√£o tratado</option>
          </select>
        </div>

        <div class="mv-actions">
          <button class="mv-btn secondary" id="btnLimpar">Limpar filtros</button>
        </div>
      </div>

      <div class="mv-field">
        <label for="pasteData">Cole aqui os dados (copiado do Excel / CSV)</label>
        <textarea id="pasteData" placeholder="Cole as linhas aqui (com tabula√ß√£o). Exemplo:
Equipe\tData agendamento\tPlaca\tTipo\tObserva√ß√µes\tTratado
Equipe 01\t01-02-2026 10:00\tTEAH123\tCarro\tTroca de pneu\tTRUE"></textarea>
      </div>

      <div class="mv-actions">
        <button class="mv-btn" id="btnCarregar">Carregar dados</button>
        <button class="mv-btn secondary" id="btnExemplo">Carregar exemplo</button>
 <button class="mv-btn secondary" id="btnBaixarRelatorio">Baixar Relat√≥rio</button>
      </div>

      <!-- Tabela -->
      <div class="mv-table-wrap" role="region" aria-label="Tabela de manuten√ß√£o">
        <table class="mv-table">
          <thead>
            <tr>
              <th>Equipe</th>
              <th>Data</th>
              <th>Placa</th>
              <th>Tipo</th>
              <th>Criticidade</th>
              <th>Status</th>
              <th>Observa√ß√µes</th>
            </tr>
          </thead>
          <tbody id="mvTbody">
            <tr>
              <td colspan="7" class="mv-empty">
                Nenhum registro carregado ainda. Cole os dados acima e clique <strong>Carregar dados</strong>.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </main>

  

  <!-- Modal (Quadro flutuante) de detalhes -->
  <div class="mv-modal-overlay" id="mvModalOverlay" aria-hidden="true">
    <div class="mv-modal" role="dialog" aria-modal="true" aria-labelledby="mvModalTitle">
      <div class="mv-modal-header">
        <h3 class="mv-modal-title" id="mvModalTitle">Detalhes da manuten√ß√£o</h3>
        <button type="button" class="mv-modal-close" id="mvModalClose" aria-label="Fechar">√ó</button>
      </div>
      <div class="mv-modal-body" id="mvModalBody"></div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- JS local s√≥ desta p√°gina: render tabela + filtros + contadores + criticidade -->
  <script>
    // Dataset da p√°gina (vazio at√© colar ou carregar exemplo)
    let mvData = [];
    let mvLastRendered = [];

    const el = (id) => document.getElementById(id);
    const tbody = el("mvTbody");

    // filtros
    const filterEquipe = el("filterEquipe");
    const filterDateStart = el("filterDateStart");
    const filterDateEnd = el("filterDateEnd");
    const filterCriticidade = el("filterCriticidade");
    const filterTipo = el("filterTipo");
    const filterStatus = el("filterStatus");

    function normalize(s){
      return (s || "").toString().trim().toLowerCase();
    }

    

    // ============================== 
    // Modal (Detalhes) 
    // ============================== 
    let lastFocusedEl = null;

    function escapeHtml(str){
  return (str || "").toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function getModalEls(){
      return {
        overlay: document.getElementById("mvModalOverlay"),
        closeBtn: document.getElementById("mvModalClose"),
        body: document.getElementById("mvModalBody")
      };
    }

    function openDetailsModal(row){
      const { overlay, closeBtn, body } = getModalEls();
      if (!overlay || !body) return;

      lastFocusedEl = document.activeElement;

      const status = getStatusTag(row);
      const crit = getCriticidade(row);

      const fields = [
        { label: "Equipe", value: row.equipe || "‚Äî" },
        { label: "Data", value: row.data || "‚Äî" },
        { label: "Placa", value: row.placa || "‚Äî" },
        { label: "Tipo", value: row.tipo || "‚Äî" },
        { label: "Criticidade", value: (crit === "alta" ? "Alta" : crit === "media" ? "M√©dia" : crit === "baixa" ? "Baixa" : "‚Äî") },
        { label: "Status", value: status.text || "‚Äî" },
        { label: "Tratado", value: (normalize(row.tratado) === "true" ? "TRUE" : (normalize(row.tratado) === "false" ? "FALSE" : "‚Äî")) },
        { label: "Observa√ß√µes", value: (row.observacoes || "‚Äî") }
      ];

      body.innerHTML = `
        <div class="mv-details-grid">
          ${fields.map(f => `
            <div class="mv-detail">
              <div class="mv-detail-label">${escapeHtml(f.label)}</div>
              <div class="mv-detail-value">${escapeHtml(f.value)}</div>
            </div>
          `).join("")}
        </div>
      `;

      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      if (closeBtn) closeBtn.focus();
    }

    function closeDetailsModal(){
      const { overlay } = getModalEls();
      if (!overlay) return;

      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";

      if (lastFocusedEl && typeof lastFocusedEl.focus === "function"){
        lastFocusedEl.focus();
      }
    }

    // Delega√ß√£o de eventos: funciona mesmo ap√≥s re-render da tabela
    document.addEventListener("click", (e) => {
      const detailsBtn = e.target.closest("button.mv-details-btn[data-details='1']");
      if (detailsBtn){
        const idx = Number(detailsBtn.getAttribute("data-row"));
        if (!Number.isNaN(idx) && mvLastRendered && mvLastRendered[idx]){
          openDetailsModal(mvLastRendered[idx]);
        }
        return;
      }

      if (e.target && e.target.id === "mvModalClose"){
        closeDetailsModal();
        return;
      }

      const overlay = document.getElementById("mvModalOverlay");
      if (overlay && e.target === overlay){
        closeDetailsModal();
      }
    });

    document.addEventListener("keydown", (e) => {
      const overlay = document.getElementById("mvModalOverlay");
      if (e.key === "Escape" && overlay && overlay.classList.contains("open")){
        closeDetailsModal();
      }
    });
// ==============================
    // Criticidade (persist√™ncia)
    // ==============================
    const CRIT_KEY = "portal_vmo_manutencao_criticidade_v1";

    function rowKey(row){
      // chave est√°vel: equipe + data + placa + tipo
      return encodeURIComponent(`${row.equipe || ""}|${row.data || ""}|${row.placa || ""}|${row.tipo || ""}`);
    }

    function loadCritMap(){
      try{
        return JSON.parse(localStorage.getItem(CRIT_KEY) || "{}") || {};
      }catch(e){
        return {};
      }
    }

    function saveCritMap(map){
      localStorage.setItem(CRIT_KEY, JSON.stringify(map));
    }

    function getCriticidade(row){
      const map = loadCritMap();
      const key = rowKey(row);
      const stored = map[key];
      const base = normalize(row.criticidade);
      // padr√£o: m√©dia
      return stored || (base ? base : "media");
    }

    function setCriticidade(row, value){
      const map = loadCritMap();
      map[rowKey(row)] = value;
      saveCritMap(map);
    }

    // ==============================
    // Data helpers
    // ==============================
    // Aceita:
    // - "DD-MM-AAAA HH:mm"
    // - "DD/MM/AAAA"
    // - "AAAA-MM-DD" (date input)
    function parseAnyDate(value){
      const s = (value || "").toString().trim();
      if (!s) return null;

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
        const [y,m,d] = s.split("-").map(Number);
        return new Date(y, m - 1, d);
      }

      const parts = s.split(" ");
      const datePart = parts[0] || "";
      const timePart = parts[1] || "";

      let dd, mm, yyyy;
      if (datePart.includes("-")){
        [dd, mm, yyyy] = datePart.split("-").map(Number);
      } else if (datePart.includes("/")){
        [dd, mm, yyyy] = datePart.split("/").map(Number);
      } else {
        return null;
      }

      if (!dd || !mm || !yyyy) return null;

      let hh = 0, min = 0;
      if (timePart && timePart.includes(":")){
        const [h, m] = timePart.split(":").map(Number);
        hh = Number.isFinite(h) ? h : 0;
        min = Number.isFinite(m) ? m : 0;
      }

      return new Date(yyyy, mm - 1, dd, hh, min, 0, 0);
    }

    function inDateRange(rowDate, startISO, endISO){
      if (!startISO && !endISO) return true;
      if (!rowDate) return false;

      const start = startISO ? parseAnyDate(startISO) : null;
      const end = endISO ? parseAnyDate(endISO) : null;
      if (end) end.setHours(23, 59, 59, 999); // inclusivo

      if (start && rowDate < start) return false;
      if (end && rowDate > end) return false;
      return true;
    }

    // ==============================
    // Status
    // ==============================
    function getStatusTag(row){
      const tratado = normalize(row.tratado);
      const pend = normalize(row.status) === "pendente";
      if (pend) return { text: "Pendente", cls: "warn" };
      if (tratado === "true") return { text: "Tratado", cls: "ok" };
      if (tratado === "false") return { text: "N√£o tratado", cls: "danger" };
      return { text: "‚Äî", cls: "neutral" };
    }

    // ==============================
    // Popula filtro de equipe
    // ==============================
    function populateEquipeFilter(){
      const current = normalize(filterEquipe.value);

      const equipes = [...new Set(mvData.map(r => (r.equipe || "").toString().trim()).filter(Boolean))]
        .sort((a,b) => a.localeCompare(b, "pt-BR"));

      filterEquipe.innerHTML = `<option value="">Todas</option>`;
      equipes.forEach(eq => {
        const opt = document.createElement("option");
        opt.value = normalize(eq);
        opt.textContent = eq;
        filterEquipe.appendChild(opt);
      });

      if (current){
        const stillExists = equipes.some(eq => normalize(eq) === current);
        filterEquipe.value = stillExists ? current : "";
      } else {
        filterEquipe.value = "";
      }
    }

    // ==============================
    // Render
    // ==============================
    function renderTable(list){
      mvLastRendered = list;
      tbody.innerHTML = "";
      if (!list.length){
        tbody.innerHTML = `
          <tr><td colspan="7" class="mv-empty">Nenhum registro encontrado com os filtros atuais.</td></tr>
        `;
        return;
      }

      list.forEach((row, i) => {
      const rowIndex = i;
        const status = getStatusTag(row);
        const obs = (row.observacoes || "").toString();
        const short = obs.length > 55 ? obs.slice(0, 55) + "..." : obs;
        const tipo = row.tipo || "‚Äî";

        const crit = getCriticidade(row);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.equipe || "‚Äî"}</td>
          <td>${row.data || "‚Äî"}</td>
          <td><strong>${row.placa || "‚Äî"}</strong></td>
          <td>${tipo}</td>
          <td>
            <select class="crit-select ${crit}" data-crit="1" aria-label="Selecionar criticidade">
              <option value="baixa" ${crit === "baixa" ? "selected" : ""}>Baixa</option>
              <option value="media" ${crit === "media" ? "selected" : ""}>M√©dia</option>
              <option value="alta" ${crit === "alta" ? "selected" : ""}>Alta</option>
            </select>
          </td>
          <td><span class="badge ${status.cls}">${status.text}</span></td>
          <td>
  <button type="button" class="mv-details-btn" data-details="1" data-row="${rowIndex}">Ver detalhes</button>
</td>
        `;

        // listener criticidade
        const select = tr.querySelector('select[data-crit="1"]');
        select.addEventListener("change", () => {
          const val = normalize(select.value);
          setCriticidade(row, val);
          select.classList.remove("baixa", "media", "alta");
          select.classList.add(val);
          applyFilters();
        });

        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".mv-more").forEach(btn => {
        btn.addEventListener("click", () => {
          const full = decodeURIComponent(btn.getAttribute("data-full"));
          alert(full);
        });
      });
    }

    function updateKpis(all){
      if (!all.length) return;

      const total = all.length;
      const tratados = all.filter(r => normalize(r.tratado) === "true").length;
      const naoTratados = all.filter(r => normalize(r.tratado) === "false").length;
      const pendentes = all.filter(r => normalize(r.status) === "pendente").length;

      el("kpiTotal").textContent = total;
      el("kpiTrue").textContent = tratados;
      el("kpiFalse").textContent = naoTratados;
      el("kpiPendentes").textContent = pendentes;
    }

    // ==============================
    // Filtros
    // ==============================
    function applyFilters(){
      const eq = normalize(filterEquipe.value);
      const ds = filterDateStart.value;
      const de = filterDateEnd.value;
      const cr = normalize(filterCriticidade.value);
      const tipo = normalize(filterTipo.value);
      const st = normalize(filterStatus.value);

      const filtered = mvData.filter(row => {
        // Equipe
        if (eq && normalize(row.equipe) !== eq) return false;

        // Data (intervalo)
        const rowDate = parseAnyDate(row.data);
        if (!inDateRange(rowDate, ds, de)) return false;

        // Criticidade
        if (cr){
          const rowCrit = getCriticidade(row);
          if (rowCrit !== cr) return false;
        }

        // Tipo
        if (tipo && normalize(row.tipo) !== tipo) return false;

        // Status
        if (st){
          const tratado = normalize(row.tratado);
          const pendente = normalize(row.status) === "pendente";
          if (st === "pendente" && !pendente) return false;
          if (st === "tratado" && tratado !== "true") return false;
          if (st === "nao_tratado" && tratado !== "false") return false;
        }

        return true;
      });

      renderTable(filtered);
      updateKpis(mvData);
    }

    // ==============================
    // Import (Excel/CSV)
    // ==============================
    function parsePasted(text){
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (lines.length < 2) return [];

      const headerLine = lines[0];
      let sep = "\t";
      if (!headerLine.includes("\t") && headerLine.includes(";")) sep = ";";
      if (!headerLine.includes("\t") && headerLine.includes(",") && !headerLine.includes(";")) sep = ",";

      const headers = headerLine.split(sep).map(h => normalize(h));

      const idx = (nameVariants) => {
        for (const v of nameVariants){
          const i = headers.indexOf(normalize(v));
          if (i >= 0) return i;
        }
        return -1;
      };

      const iEquipe = idx(["equipe","equipe / grupo","grupo"]);
      const iData = idx(["data","data agendamento","data agendada","data agendamento"]);
      const iPlaca = idx(["placa","placa do veiculo","placa do ve√≠culo"]);
      const iTipo = idx(["tipo","tipo veiculo","tipo do veiculo","tipo do ve√≠culo"]);
      const iObs = idx(["observacoes","observa√ß√µes","obs"]);
      const iTratado = idx(["tratado","true/false","status tratado"]);
      const iCrit = idx(["criticidade","crit"]);

      const out = [];
      for (let r = 1; r < lines.length; r++){
        const cols = lines[r].split(sep).map(c => c.trim());
        if (cols.length < 3) continue;

        const row = {
          equipe: iEquipe >= 0 ? cols[iEquipe] : "",
          data: iData >= 0 ? cols[iData] : "",
          placa: iPlaca >= 0 ? cols[iPlaca] : "",
          tipo: iTipo >= 0 ? cols[iTipo] : "",
          observacoes: iObs >= 0 ? cols[iObs] : "",
          tratado: iTratado >= 0 ? cols[iTratado] : "",
          criticidade: iCrit >= 0 ? normalize(cols[iCrit]) : "",
          status: ""
        };

        // normaliza criticidade caso venha como "alto/m√©dio/baixo"
        if (row.criticidade === "alto") row.criticidade = "alta";
        if (row.criticidade === "m√©dio" || row.criticidade === "medio") row.criticidade = "media";
        if (row.criticidade === "baixo") row.criticidade = "baixa";

        // Heur√≠stica: se texto tiver "pend" nas observa√ß√µes, marca como pendente
        if (normalize(row.observacoes).includes("pend")) row.status = "pendente";

        out.push(row);
      }
      return out;
    }

    
// ==============================
// PDF - Baixar Relat√≥rio
// ==============================

function formatNow(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}

function getFiltroResumo(){
  const eqTxt = (filterEquipe && filterEquipe.value) ? (filterEquipe.options[filterEquipe.selectedIndex]?.textContent || filterEquipe.value) : 'Todas';
  const ds = filterDateStart?.value ? filterDateStart.value : '‚Äî';
  const de = filterDateEnd?.value ? filterDateEnd.value : '‚Äî';
  const crTxt = (filterCriticidade && filterCriticidade.value) ? (filterCriticidade.options[filterCriticidade.selectedIndex]?.textContent || filterCriticidade.value) : 'Todas';
  const tipoTxt = (filterTipo && filterTipo.value) ? (filterTipo.options[filterTipo.selectedIndex]?.textContent || filterTipo.value) : 'Todos';
  const stTxt = (filterStatus && filterStatus.value) ? (filterStatus.options[filterStatus.selectedIndex]?.textContent || filterStatus.value) : 'Todos';
  return { eqTxt, ds, de, crTxt, tipoTxt, stTxt };
}

function gerarPdfRelatorio(){
  if (typeof html2pdf === 'undefined'){
    alert('Biblioteca de PDF (html2pdf) n√£o carregou. Verifique sua internet e tente novamente.');
    return;
  }

  const rows = Array.isArray(mvLastRendered) ? mvLastRendered : [];
  if (!rows.length){
    alert('Sem registros vis√≠veis para gerar o relat√≥rio.');
    return;
  }

  const { eqTxt, ds, de, crTxt, tipoTxt, stTxt } = getFiltroResumo();

  const wrap = document.createElement('div');
  wrap.className = 'mv-print-area';

  const title = 'Relat√≥rio - Manuten√ß√£o de viaturas';
  const meta = `
    <div class="meta">
      <div><strong>Gerado em:</strong> ${escapeHtml(new Date().toLocaleString('pt-BR'))}</div>
      <div><strong>Filtros:</strong> Equipe: ${escapeHtml(eqTxt)} ‚Ä¢ Data: ${escapeHtml(ds)} at√© ${escapeHtml(de)} ‚Ä¢ Criticidade: ${escapeHtml(crTxt)} ‚Ä¢ Tipo: ${escapeHtml(tipoTxt)} ‚Ä¢ Status: ${escapeHtml(stTxt)}</div>
      <div><strong>Total vis√≠vel:</strong> ${rows.length}</div>
    </div>
  `;

  const bodyRows = rows.map(r => {
    const crit = getCriticidade(r);
    const critTxt = (crit === 'alta') ? 'Alta' : (crit === 'media' ? 'M√©dia' : (crit === 'baixa' ? 'Baixa' : '‚Äî'));
    const status = getStatusTag(r);
    const statusTxt = status?.text || '‚Äî';
    const obsFull = (r.observacoes || '‚Äî').toString();

    return `
      <tr>
        <td>${escapeHtml(r.equipe || '‚Äî')}</td>
        <td>${escapeHtml(r.data || '‚Äî')}</td>
        <td>${escapeHtml(r.placa || '‚Äî')}</td>
        <td>${escapeHtml(r.tipo || '‚Äî')}</td>
        <td>${escapeHtml(critTxt)}</td>
        <td>${escapeHtml(statusTxt)}</td>
        <td>${escapeHtml(obsFull)}</td>
      </tr>
    `;
  }).join('');

  wrap.innerHTML = `
    <h2>${escapeHtml(title)}</h2>
    ${meta}
    <table>
      <thead>
        <tr>
          <th>Equipe</th>
          <th>Data</th>
          <th>Placa</th>
          <th>Tipo</th>
          <th>Criticidade</th>
          <th>Status</th>
          <th>Observa√ß√µes</th>
        </tr>
      </thead>
      <tbody>${bodyRows}</tbody>
    </table>
  `;

  document.body.appendChild(wrap);

  // for√ßa layout antes da captura
  wrap.getBoundingClientRect();

  const fileName = `relatorio_manutencao_viaturas_${formatNow()}.pdf`;

  const opt = {
    margin: [8, 8, 8, 8],
    filename: fileName,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: {
      scale: 2,
      backgroundColor: '#ffffff',
      scrollY: 0,
      scrollX: 0,
      windowWidth: wrap.scrollWidth,
      windowHeight: wrap.scrollHeight
    },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
  };

  // espera um pouco para garantir renderiza√ß√£o completa
  setTimeout(() => {
    html2pdf().set(opt).from(wrap).save().then(() => {
      wrap.remove();
    }).catch((err) => {
      wrap.remove();
      console.error(err);
      alert('Falha ao gerar o PDF. Abra o console (F12) para ver o erro.');
    });
  }, 250);
}

// ==============================
    // Eventos
    // ==============================
    ["input", "change"].forEach(evt => {
      filterEquipe.addEventListener(evt, applyFilters);
      filterDateStart.addEventListener(evt, applyFilters);
      filterDateEnd.addEventListener(evt, applyFilters);
      filterCriticidade.addEventListener(evt, applyFilters);
      filterTipo.addEventListener(evt, applyFilters);
      filterStatus.addEventListener(evt, applyFilters);
    });

    el("btnLimpar").addEventListener("click", () => {
      filterEquipe.value = "";
      filterDateStart.value = "";
      filterDateEnd.value = "";
      filterCriticidade.value = "";
      filterTipo.value = "";
      filterStatus.value = "";
      applyFilters();
    });

    el("btnCarregar").addEventListener("click", () => {
      const txt = el("pasteData").value.trim();
      const parsed = parsePasted(txt);
      if (!parsed.length){
        alert("N√£o consegui ler os dados. Cole novamente com cabe√ßalho + linhas (preferencialmente do Excel).\n\nDica: Cole com colunas: Equipe, Data agendamento, Placa, Tipo, Observa√ß√µes, Tratado");
        return;
      }
      mvData = parsed;
      populateEquipeFilter();
      applyFilters();
    });

    el("btnExemplo").addEventListener("click", () => {
      mvData = [
        {
          "equipe": "SP - CAMPINAS - BASE ‚Äî ISACTEEP SPI - EQUIPE 4 - CABREUVA",
          "data": "01-02-2026 06:00",
          "placa": "TEJ6G14",
          "tipo": "Carro",
          "observacoes": "Avaria no parachoque trazeiro",
          "tratado": "TRUE",
          "status": "",
          "criticidade": "media"
        },
        {
          "equipe": "SPI - GUARAREMA - 01 ‚Äî VMO - TBG - GUARAREMA",
          "data": "01-02-2026 06:00",
          "placa": "TEW2E60",
          "tipo": "SUV",
          "observacoes": "Equipe Diurna: Adomiciano Costa, MT: 5704169. Condutor: 06h √†s 12h. Alvaro Cunha, MT: 5704171. Condutor: 12h √†s 18h.",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "alta"
        },
        {
          "equipe": "BA - SALVADOR - BASE ‚Äî EQUIPE VMO - QUEPAR - BAHIA",
          "data": "02-02-2026 10:00",
          "placa": "TDG9F48",
          "tipo": "Carro",
          "observacoes": "Abertura para in√≠cio da ronda da QUEPAR",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "baixa"
        },

        {
          "equipe": "ISACTEEP SPI - EQUIPE 1 CAPAO BONITO",
          "data": "13-02-2026 18:00",
          "placa": "TEA3H97",
          "tipo": "Carro",
          "observacoes": "N/A carro apitando  sem parar ",
          "tratado": "FALSE",
          "status": "pendente",
          "criticidade": "baixa"
        },
      ];
      populateEquipeFilter();
      applyFilters();
    });

 el("btnBaixarRelatorio").addEventListener("click", gerarPdfRelatorio);

    // Inicializa
    applyFilters();
  </script>
</body>
</html>
