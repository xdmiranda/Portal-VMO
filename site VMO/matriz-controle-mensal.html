<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proje√ß√£o de KM¬¥s</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="script.js" defer></script>

  <!-- Estilo local (s√≥ desta p√°gina) -->
  <style>
    .mx-wrap { display:flex; flex-direction:column; gap:40px; }
    .mx-subtitle { margin-top:6px; color:#666; }

    .mx-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
      margin-top:10px;
    }

    .mx-kpi{
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,0.06);
      border-left:6px solid #f2c200;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:72px;
    }
    .mx-kpi.ok{ border-left-color:#2ecc71; }
    .mx-kpi.warn{ border-left-color:#f39c12; }
    .mx-kpi.danger{ border-left-color:#e74c3c; }
    .mx-kpi.neutral{ border-left-color:#95a5a6; }
    .mx-kpi .label{ font-size:12px; color:#666; font-weight:800; text-transform:uppercase; letter-spacing:.3px; }
    .mx-kpi .value{ font-size:26px; font-weight:900; color:#222; line-height:1; }
    .mx-kpi .hint{ font-size:12px; color:#777; }

    .mx-toolbar{
      display:grid;
      grid-template-columns: 1fr 1.6fr 1fr 1fr 1fr auto;
      gap:10px;
      align-items:end;
      margin-top:6px;
    }
    .mx-field label{
      display:block;
      font-size:12px;
      color:#666;
      font-weight:900;
      margin-bottom:6px;
    }
    .mx-field input, .mx-field select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid #e4e4e4;
      outline:none;
      font-family:inherit;
      font-size:14px;
      background:#fff;
      box-sizing:border-box;
    }

    .mx-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .mx-btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius:10px;
      padding:10px 12px;
      font-weight:900;
      background:#f2c200;
      color:#222;
      box-shadow:0 10px 20px rgba(0,0,0,0.08);
      transition:transform .2s ease, opacity .2s ease;
      white-space:nowrap;
    }
    .mx-btn:hover{ transform: translateY(-1px); opacity:.95; }
    .mx-btn.secondary{ background:#f3f3f3; }

    .mx-note{
      background:#fff7d1;
      border:1px solid rgba(242,194,0,.35);
      padding:10px 12px;
      border-radius:12px;
      color:#444;
      font-size:13px;
      line-height:1.35;
    }

    .mx-panels{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .mx-panel{
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,0.06);
      border:1px solid #eee;
      padding:14px;
    }
    .mx-panel h3{
      margin:0 0 10px 0;
      font-size:14px;
      color:#222;
      letter-spacing:.2px;
    }
    .mx-list{
      margin:0;
      padding-left:18px;
      color:#444;
      line-height:1.6;
      font-size:13px;
    }
    .mx-list li{ margin:6px 0; }

    .mx-table-wrap{
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(0,0,0,0.06);
      overflow:hidden;
      border:1px solid #eee;
    }
    table.mx-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .mx-table thead th{
      text-align:left;
      padding:12px;
      background:#fafafa;
      border-bottom:1px solid #eee;
      color:#333;
      font-weight:900;
      position:sticky;
      top:0;
      z-index:1;
    }
    .mx-table tbody td{
      padding:12px;
      border-bottom:1px solid #f0f0f0;
      vertical-align:top;
      color:#333;
    }
    .mx-table tbody tr:hover{
      background: rgba(242,194,0,0.08);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .badge.ok{ background: rgba(46,204,113,.12); color:#1f7a43; border-color: rgba(46,204,113,.25); }
    .badge.warn{ background: rgba(243,156,18,.12); color:#8a5a07; border-color: rgba(243,156,18,.25); }
    .badge.danger{ background: rgba(231,76,60,.12); color:#8c2b22; border-color: rgba(231,76,60,.25); }
    .badge.neutral{ background: rgba(149,165,166,.14); color:#4b5a5a; border-color: rgba(149,165,166,.25); }

    .mx-empty{
      padding:16px;
      color:#666;
      font-size:13px;
    }

    @media (max-width: 980px){
      .mx-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .mx-toolbar{ grid-template-columns: 1fr 1fr; }
      .mx-panels{ grid-template-columns: 1fr; }
    }
    @media (max-width: 560px){
      .mx-grid{ grid-template-columns: 1fr; }
      .mx-toolbar{ grid-template-columns: 1fr; }
      .mx-actions{ justify-content: stretch; }
      .mx-btn{ width:100%; }
    }
  

  /* ===============================
     Resumo por Cliente (Cards)
  =============================== */
  .mx-client-wrap{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .mx-client-header h3{
    margin:0;
    font-size:14px;
    color:#222;
    letter-spacing:.2px;
  }
  .mx-client-sub{
    margin:4px 0 0;
    color:#666;
    font-size:12px;
    line-height:1.35;
  }
  .mx-client-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap:12px;
  }
  .mx-client-card{
    background:#fff;
    border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,0.06);
    border-left:6px solid #f2c200;
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:92px;
  }
  .mx-client-card.ok{ border-left-color:#2ecc71; }
  .mx-client-card.warn{ border-left-color:#f39c12; }
  .mx-client-card.danger{ border-left-color:#e74c3c; }
  .mx-client-card.neutral{ border-left-color:#95a5a6; }
  .mx-client-title{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    border-left-color:#eeb60d; 
  }
  .mx-client-title .name{
    font-size:12px;
    font-weight:900;
    color:#333;
    text-transform:uppercase;
    letter-spacing:.3px;
  }
  .mx-client-title .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid transparent;
    white-space:nowrap;
    background: rgba(149,165,166,.14);
    color:#4b5a5a;
    border-color: rgba(149,165,166,.25);
  }
  .mx-client-card.ok .pill{ background: rgba(46,204,113,.12); color:#1f7a43; border-color: rgba(46,204,113,.25); }
  .mx-client-card.warn .pill{ background: rgba(243,156,18,.12); color:#8a5a07; border-color: rgba(243,156,18,.25); }
  .mx-client-card.danger .pill{ background: rgba(231,76,60,.12); color:#8c2b22; border-color: rgba(231,76,60,.25); }

  .mx-client-metrics{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px 12px;
  }
  .mx-metric{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .mx-metric .k{
    font-size:11px;
    color:#666;
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.25px;
  }
  .mx-metric .v{
    font-size:14px;
    color:#222;
    font-weight:900;
    line-height:1.2;
  }
  .mx-metric .v.neg{ color:#8c2b22; }
  .mx-metric .v.pos{ color:#1f7a43; }
  .mx-metric .v.loss{ color:#8c2b22; }
  .mx-metric.full{ grid-column: 1 / -1; }

</style>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="left-section">
      <div class="hamburger" id="menuToggle" role="button" tabindex="0" aria-controls="navMenu" aria-expanded="false">‚ò∞</div>

      <div class="brand">
        <div class="brand-loader-container" aria-hidden="true">
          <div class="loader">
            <div class="truckWrapper">
              <div class="truckBody">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 198 93" class="trucksvg">
                  <path stroke-width="3" stroke="#282828" fill="#F83D3D"
                    d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z"></path>
                  <path stroke-width="3" stroke="#282828" fill="#7D7C7C"
                    d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z"></path>
                  <path stroke-width="2" stroke="#282828" fill="#282828"
                    d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z"></path>
                  <rect stroke-width="2" stroke="#282828" fill="#FFFCAB" rx="1" height="7" width="5" y="63" x="187"></rect>
                  <rect stroke-width="2" stroke="#282828" fill="#282828" rx="1" height="11" width="4" y="81" x="193"></rect>
                  <rect stroke-width="3" stroke="#282828" fill="#DFDFDF" rx="2.5" height="90" width="121" y="1.5" x="6.5"></rect>
                  <rect stroke-width="2" stroke="#282828" fill="#DFDFDF" rx="2" height="4" width="6" y="84" x="1"></rect>
                </svg>
              </div>
              <div class="truckTires">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                  <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                  <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                  <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                  <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
                </svg>
              </div>
              <div class="road"></div>
              <svg xml:space="preserve" viewBox="0 0 453.459 453.459"
                xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"
                id="Capa_1" version="1.1" fill="#000000" class="lampPost">
                <path d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993
c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514
c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16
c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914
h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75
v-11.202c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066c0-5.068-4.107-9.177-9.176-9.177h-0.795
V196.641c0-43.174,14.942-54.283,30.762-66.043c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0z
M232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514c0-5.531,1.078-10.957,3.141-16.017
h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"></path>
              </svg>
            </div>
          </div>
        </div>

        <span class="brand-name">Portal VMO</span>
      </div>
    </div>

    <div class="right-section">
      <div class="icons"><span>üìù</span><span>‚òëÔ∏è</span><span>üîç</span></div>
      <div class="divider"></div>
      <div class="user-info">
        <strong>ANDREI CERQUEIRA DE MIRANDA</strong>
        <span>VMO ‚Äî Gest√£o / Global TDI</span>
      </div>
      <div class="divider"></div>
      <div class="region"><span>üåé Brasil</span><span>pt-BR ‚ñæ</span><span>‚èª</span></div>
    </div>
  </header>

  <!-- Menu lateral -->
   <div class="nav-overlay" id="navOverlay"></div>
  <nav class="nav" id="navMenu" aria-label="Menu do Portal">
    <a href="index.html">In√≠cio</a>
    <a href="relatorios.html">Relat√≥rios Di√°rios</a>
    <a href="neo.html">Confirma√ß√µes Neo Energia</a>
    <a href="ecomp.html">Confirma√ß√µes Ecomp</a>
    <a href="km.html">Controle de KM</a>
    <a href="orientacoes.html">Orienta√ß√µes da √°rea</a>
    <a href="pops.html">POPS</a>
    <a href="ocorrencias.html">Ocorr√™ncias</a>
    <a href="matriz-controle-mensal.html">Matriz de controle mensal</a>
    <a href="manutencao-veiculos.html">Manuten√ß√£o de ve√≠culos</a>
  </nav>

  <main class="content-page">
    <div class="mx-wrap">
      <a href="index.html" class="back-btn">‚Üê Voltar</a>

      <div>
        <h1 style="margin:0;">Proje√ß√£o KM¬¥s</h1>
       
      </div>

      <!-- KPIs -->
      <div class="mx-grid" aria-label="Resumo">
        <div class="mx-kpi neutral">
          <div class="label">Total de equipes</div>
          <div class="value" id="kpiTotal">0</div>
          <div class="hint">No m√™s selecionado</div>
        </div>
        <div class="mx-kpi danger">
          <div class="label">Excedeu</div>
          <div class="value" id="kpiExcedeu">0</div>
          <div class="hint">Equipes excedentes</div>
        </div>
        <div class="mx-kpi warn">
          <div class="label">Vai exceder</div>
          <div class="value" id="kpiVaiExceder">0</div>
          <div class="hint">Proje√ß√£o final do m√™s</div>
        </div>
        <div class="mx-kpi ok">
          <div class="label">Dentro</div>
          <div class="value" id="kpiDentro">0</div>
          <div class="hint">Dentro do esperado</div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="mx-toolbar">
        <div class="mx-field">
  <label for="filterCliente">Cliente</label>
  <select id="filterCliente">
    <option value="">Todos</option>
  </select>
</div>
<div class="mx-field">
  <label for="filterEquipe">Equipe</label>
  <select id="filterEquipe">
    <option value="">Todas</option>
  </select>
</div>
        <div class="mx-field">
          <label for="filterMes">M√™s</label>
          <select id="filterMes">

      <option value="2026-01">Janeiro - 2026</option>
      <option value="2026-02">Fevereiro - 2026</option>
      <option value="2026-03">Mar√ßo - 2026</option>
      <option value="2026-04">Abril - 2026</option>
      <option value="2026-05">Maio - 2026</option>
      <option value="2026-06">Junho - 2026</option>
      <option value="2026-07">Julho - 2026</option>
      <option value="2026-08">Agosto - 2026</option>
      <option value="2026-09">Setembro - 2026</option>
      <option value="2026-10">Outubro - 2026</option>
      <option value="2026-11">Novembro - 2026</option>
      <option value="2026-12">Dezembro - 2026</option>
    </select>
        </div>

        <div class="mx-field">
          <label for="filterStatus">Status</label>
          <select id="filterStatus">
            <option value="">Todos</option>
            <option value="excedeu">Excedeu</option>
            <option value="vai_exceder">Vai exceder</option>
            <option value="dentro">Dentro</option>
          </select>
        </div>

        <div class="mx-field">
          <label for="sortBy">Ordenar</label>
          <select id="sortBy">
            <option value="risco_desc">Maior risco</option>
            <option value="desvio_desc">Maior desvio</option>
            <option value="rodado_desc">Maior rodado</option>
            <option value="equipe_asc">Equipe A-Z</option>
          </select>
        </div>

        <div class="mx-actions">
          <button class="mx-btn secondary" id="btnLimpar">Limpar</button>
        <button class="mx-btn secondary" id="btnBaixarRelatorio">Baixar Relat√≥rio</button>
        </div>
      </div>

      <!-- Resumo por cliente (substitui os pain√©is) -->
<div class="mx-client-wrap" aria-label="Resumo por cliente">
  <div class="mx-client-header">
    <h3>üìå Resumo por cliente</h3>
    <p class="mx-client-sub">Os valores abaixo respeitam os filtros aplicados (m√™s, cliente, equipe, status e ordena√ß√£o).</p>
  </div>
  <div class="mx-client-grid" id="mxClienteCards">
    <div class="mx-empty">Carregando‚Ä¶</div>
  </div>
</div>

<!-- Tabela -->
      <div class="mx-table-wrap" role="region" aria-label="Tabela de matriz mensal">
        <table class="mx-table">
          <thead>
        <tr>
          <th>Cliente</th>
          <th>Equipe</th>
          <th>KM contratado</th>
          <th>KM/dia (contrato)</th>
          <th>Permitido at√© o momento</th>
          <th>Rodado at√© o momento</th>
          <th>Desvio (rodado - permitido)</th>
          <th>Proje√ß√£o fim do m√™s</th>
          <th>Saldo (contratado - proje√ß√£o)</th>
          <th>Status</th>
        </tr>
      </thead>
          <tbody id="mxTbody">
            <tr><td colspan="10" class="mx-empty">Carregando‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </main>

  
<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script>window.jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : undefined;</script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@5.0.7/dist/jspdf.plugin.autotable.min.js"></script>
<script>
    // =========================================================
// ‚úÖ DADOS MANUAIS
// =========================================================
const matrixData = [
   // ========= JANEIRO/2026 =========
    { mes: "2026-01", equipe: "ISACTEEP SPC - EQUIPE LESTE", kmContratado: 800, kmDisponivelDia: 29, kmPermitidoAteMomento: 411, rodadoAteMomento: 389 },
    { mes: "2026-01", equipe: "ISACTEEP SPC - EQUIPE INTERLAGOS", kmContratado: 500, kmDisponivelDia: 16.13, kmPermitidoAteMomento: 500, rodadoAteMomento: 371 },
    { mes: "2026-01", equipe: "ISACTEEP SPC - EQUIPE JANDIRA", kmContratado: 1150, kmDisponivelDia: 37.1, kmPermitidoAteMomento: 1150, rodadoAteMomento: 1834 },
    { mes: "2026-01", equipe: "ISACTEEP SPI - EQUIPE 1 CAPAO BONITO", kmContratado: 3700, kmDisponivelDia: 119.35, kmPermitidoAteMomento: 3700, rodadoAteMomento: 919 },
    { mes: "2026-01", equipe: "ISACTEEP SPI - EQUIPE 2 - SAO JOAO DA B.V", kmContratado: 3200, kmDisponivelDia: 103.23, kmPermitidoAteMomento: 3200, rodadoAteMomento: 4161 },
    { mes: "2026-01", equipe: "ISACTEEP SPI - EQUIPE 3 - BRAGAN√áA PAULISTA", kmContratado: 520, kmDisponivelDia: 16.77, kmPermitidoAteMomento: 520, rodadoAteMomento: 3244 },
    { mes: "2026-01", equipe: "ISACTEEP SPI - EQUIPE 4 - CABREUVA", kmContratado: 1925, kmDisponivelDia: 62.1, kmPermitidoAteMomento: 1925, rodadoAteMomento: 2724 },
    { mes: "2026-01", equipe: "ISACTEEP SPI - EQUIPE BAIXADA", kmContratado: 300, kmDisponivelDia: 9.68, kmPermitidoAteMomento: 300, rodadoAteMomento: 445 },
    { mes: "2026-01", equipe: "ISACTEEP SPI - EQUIPE LORENA", kmContratado: 1400, kmDisponivelDia: 45.16, kmPermitidoAteMomento: 1400, rodadoAteMomento: 197 },
    { mes: "2026-01", equipe: "ISACTEEP SPI - EQUIPE - SUMAR√â", kmContratado: 2725, kmDisponivelDia: 87.9, kmPermitidoAteMomento: 2725, rodadoAteMomento: 2195 },
    { mes: "2026-01", equipe: "Zona Operativa 1 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 145.16, kmPermitidoAteMomento: 4500, rodadoAteMomento: 4933 },
    { mes: "2026-01", equipe: "Zona Operativa 2 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 145.16, kmPermitidoAteMomento: 4500, rodadoAteMomento: 1764 },
    { mes: "2026-01", equipe: "Zona Operativa 3 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 145.16, kmPermitidoAteMomento: 4500, rodadoAteMomento: 3508 },
    { mes: "2026-01", equipe: "Zona Operativa 4 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 145.16, kmPermitidoAteMomento: 4500, rodadoAteMomento: 2645 },
    { mes: "2026-01", equipe: "Zona Operativa Interior - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 145.16, kmPermitidoAteMomento: 4500, rodadoAteMomento: 5529 },
    { mes: "2026-01", equipe: "EQUIPE VMO - QUEPAR - ALAGOAS", kmContratado: 1000, kmDisponivelDia: 32.26, kmPermitidoAteMomento: 1000, rodadoAteMomento: 2509 },
    { mes: "2026-01", equipe: "EQUIPE VMO - QUEPAR - Bahia", kmContratado: 1000, kmDisponivelDia: 32.26, kmPermitidoAteMomento: 1000, rodadoAteMomento: 1305 },
    { mes: "2026-01", equipe: "VMO - AMAZONAS", kmContratado: 434, kmDisponivelDia: 14.0, kmPermitidoAteMomento: 434, rodadoAteMomento: 1128 },
    { mes: "2026-01", equipe: "VMO - TBG - GUARAREMA", kmContratado: 11000, kmDisponivelDia: 354.84, kmPermitidoAteMomento: 11000, rodadoAteMomento: 15223 },
    { mes: "2026-01", equipe: "GLP - RJ", kmContratado: 1500, kmDisponivelDia: 48.39, kmPermitidoAteMomento: 1500, rodadoAteMomento: 6493 },

    // ========= FEVEREIRO/2026 =========
    
    { mes: "2026-02", equipe: "ISACTEEP SPC - EQUIPE LESTE", kmContratado: 800, kmDisponivelDia: 29, kmPermitidoAteMomento: 580, rodadoAteMomento: 389 },
    { mes: "2026-02", equipe: "ISACTEEP SPC - EQUIPE INTERLAGOS", kmContratado: 500, kmDisponivelDia: 18, kmPermitidoAteMomento: 360, rodadoAteMomento: 252 },
    { mes: "2026-02", equipe: "ISACTEEP SPC - EQUIPE JANDIRA", kmContratado: 1150, kmDisponivelDia: 41, kmPermitidoAteMomento: 820, rodadoAteMomento: 357 },
    { mes: "2026-02", equipe: "ISACTEEP SPI - EQUIPE 1 CAPAO BONITO", kmContratado: 3700, kmDisponivelDia: 132, kmPermitidoAteMomento: 2640, rodadoAteMomento: 250 },
    { mes: "2026-02", equipe: "ISACTEEP SPI - EQUIPE 2 - SAO JOAO DA B.V", kmContratado: 3200, kmDisponivelDia: 114, kmPermitidoAteMomento: 2280, rodadoAteMomento: 2308 },
    { mes: "2026-02", equipe: "ISACTEEP SPI - EQUIPE 3 - BRAGAN√áA PAULISTA", kmContratado: 520, kmDisponivelDia: 19, kmPermitidoAteMomento: 380, rodadoAteMomento: 2428 },
    { mes: "2026-02", equipe: "ISACTEEP SPI - EQUIPE 4 - CABREUVA", kmContratado: 1925, kmDisponivelDia: 69, kmPermitidoAteMomento: 1380, rodadoAteMomento: 2025 },
    { mes: "2026-02", equipe: "ISACTEEP SPI - EQUIPE BAIXADA", kmContratado: 300, kmDisponivelDia: 11, kmPermitidoAteMomento: 220, rodadoAteMomento: 263 },
    { mes: "2026-02", equipe: "ISACTEEP SPI - EQUIPE LORENA", kmContratado: 1400, kmDisponivelDia: 50, kmPermitidoAteMomento: 1000, rodadoAteMomento: 111 },
    { mes: "2026-02", equipe: "ISACTEEP SPI - EQUIPE - SUMAR√â", kmContratado: 2725, kmDisponivelDia: 97, kmPermitidoAteMomento: 1940, rodadoAteMomento: 2078 },

    { mes: "2026-02", equipe: "Zona Operativa 1 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 161, kmPermitidoAteMomento: 3220, rodadoAteMomento: 3334 },
    { mes: "2026-02", equipe: "Zona Operativa 2 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 161, kmPermitidoAteMomento: 3220, rodadoAteMomento: 1690 },
    { mes: "2026-02", equipe: "Zona Operativa 3 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 161, kmPermitidoAteMomento: 3220, rodadoAteMomento: 2701 },
    { mes: "2026-02", equipe: "Zona Operativa 4 - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 161, kmPermitidoAteMomento: 3220, rodadoAteMomento: 2240 },
    { mes: "2026-02", equipe: "Zona Operativa Interior - Telef√¥nica", kmContratado: 4500, kmDisponivelDia: 161, kmPermitidoAteMomento: 3220, rodadoAteMomento: 4751 },

    { mes: "2026-02", equipe: "EQUIPE VMO - QUEPAR - ALAGOAS", kmContratado: 1000, kmDisponivelDia: 36, kmPermitidoAteMomento: 720, rodadoAteMomento: 1973 },
    { mes: "2026-02", equipe: "EQUIPE VMO - QUEPAR - Bahia", kmContratado: 1000, kmDisponivelDia: 36, kmPermitidoAteMomento: 720, rodadoAteMomento: 556 },
    { mes: "2026-02", equipe: "VMO - AMAZONAS", kmContratado: 434, kmDisponivelDia: 16, kmPermitidoAteMomento: 320, rodadoAteMomento: 789 },
    { mes: "2026-02", equipe: "VMO - TBG - GUARAREMA", kmContratado: 11000, kmDisponivelDia: 393, kmPermitidoAteMomento: 7860, rodadoAteMomento: 8564 },
    { mes: "2026-02", equipe: "GLP - RJ", kmContratado: 1500, kmDisponivelDia: 54, kmPermitidoAteMomento: 1080, rodadoAteMomento: 5310 },
    ];

// =========================================================
// L√≥gica / Intera√ß√£o
// =========================================================
let mxLastRendered = [];

const $ = (id) => document.getElementById(id);
const tbody = $("mxTbody");
const filterMes = $("filterMes");
const filterStatus = $("filterStatus");
const sortBy = $("sortBy");
const filterCliente = $("filterCliente");
const filterEquipe = $("filterEquipe");
const clienteCards = $("mxClienteCards");

function normalize(s){ return (s || "").toString().trim().toLowerCase(); }

function getSelectedText(sel){
  if (!sel) return "‚Äî";
  const opt = (sel.options && sel.selectedIndex >= 0) ? sel.options[sel.selectedIndex] : null;
  return opt ? (opt.textContent || opt.innerText || sel.value || "‚Äî") : (sel.value || "‚Äî");
}

function setDefaultMes(){
  try{
    const meses = Array.from(new Set(matrixData.map(r => String(r.mes || "").trim()).filter(Boolean))).sort();
    if (meses.length) filterMes.value = meses[meses.length - 1];
  }catch(e){}
}

// =======================
// Cliente (infer√™ncia)
// =======================
function inferCliente(equipe){
  const e = (equipe || "").toString();
  const up = e.toUpperCase();

  if (up.includes("ZONA OPERATIVA") || up.includes("TELEF")) return "VIVO";
  if (up.includes("ISACTEEP") || up.includes("ISA CTEEP") || (up.includes("ISA") && up.includes("CTEEP"))) return "IsaCteep";
  if (up.includes("GLP") && up.includes("RJ")) return "GLP";
  if (up.includes("QUEPAR")) return "Quepar";
  if (up.includes("VMO") && up.includes("AMAZONAS")) return "Tai Engenharia";
  if (up.includes("TBG") && up.includes("GUARAREMA")) return "Ecomp TBG";

  return "‚Äî";
}

function getCliente(row){
  return (row && row.cliente) ? row.cliente : inferCliente(row ? row.equipe : "");
}

// =======================
// C√°lculos por equipe
// =======================
function daysInMonth(yyyy, mm){
  return new Date(yyyy, mm, 0).getDate();
}

function inferDaysPassed(row){
  // ‚úÖ Regra nova (m√™s atual): usa o dia real do m√™s (ex.: hoje = 26)
  // Assim a proje√ß√£o vira: (rodado at√© agora / diaAtual) * totalDiasDoM√™s
  try{
    const parts = (row.mes || "").split("-");
    const yyyy = Number(parts[0]);
    const mm = Number(parts[1]); // 1..12
    const hoje = new Date();
    const mesAtual = (hoje.getFullYear() === yyyy) && ((hoje.getMonth() + 1) === mm);
    if (mesAtual){
      return Math.max(1, hoje.getDate());
    }
  }catch(e){ /* ignore */ }

  // üîÅ Fallback (m√™s n√£o atual): mant√©m a l√≥gica anterior baseada no permitido
  if (!row.kmDisponivelDia || !row.kmPermitidoAteMomento) return 0;
  const d = row.kmPermitidoAteMomento / row.kmDisponivelDia;
  return Math.max(1, Math.round(d));
}
function calcRow(row){
  const parts = (row.mes || "").split("-");
  const yyyy = parts[0];
  const mmStr = parts[1];
  const mm = Number(mmStr);

  const totalDays = daysInMonth(Number(yyyy), mm);
  const daysPassed = inferDaysPassed(row);

  const permitido = Number(row.kmPermitidoAteMomento || 0);
  const rodado = Number(row.rodadoAteMomento || 0);
  const contratado = Number(row.kmContratado || 0);

  const desvio = rodado - permitido;
  const avgDia = daysPassed ? (rodado / daysPassed) : 0;
  const projFim = Math.round(avgDia * totalDays);
  const saldo = contratado - projFim;

  let status = "dentro";
  if (rodado > contratado) status = "excedeu";
  else if (projFim > contratado) status = "vai_exceder";

  const risco = -saldo;
  return { ...row, cliente: getCliente(row), totalDays, daysPassed, desvio, avgDia, projFim, saldo, status, risco };
}

function badgeFor(status){
  if (status === "excedeu") return { text:"Excedeu", cls:"danger" };
  if (status === "vai_exceder") return { text:"Vai exceder", cls:"warn" };
  return { text:"Dentro", cls:"ok" };
}

function updateKpis(list){
  const total = list.length;
  const excedeu = list.filter(r => r.status === "excedeu").length;
  const vai = list.filter(r => r.status === "vai_exceder").length;
  const dentro = list.filter(r => r.status === "dentro").length;

  $("kpiTotal").textContent = total;
  $("kpiExcedeu").textContent = excedeu;
  $("kpiVaiExceder").textContent = vai;
  $("kpiDentro").textContent = dentro;
}

// =======================
// Resumo por Cliente (Cards)
// =======================
function fmtKm(n){
  const num = Number(n || 0);
  return num.toLocaleString('pt-BR');
}

function fmtMoney(n){
  const num = Number(n || 0);
  return num.toLocaleString('pt-BR');
}
function clsSaldo(n){
  return Number(n) < 0 ? 'neg' : 'pos';
}

function cardClass(contratado, saldoProj){
  const c = Number(contratado || 0);
  const s = Number(saldoProj || 0);
  if (c <= 0) return 'neutral';
  if (s < 0) return 'danger';
  if (s <= c * 0.05) return 'warn';
  return 'ok';
}

function renderClienteCards(list){
  if (!clienteCards) return;

  if (!list.length){
    clienteCards.innerHTML = '<div class="mx-empty">Sem dados para os filtros atuais.</div>';
    return;
  }

  // Totais (respeitando filtros)
  const totalContr = list.reduce((a,r) => a + Number(r.kmContratado || 0), 0);
  const totalRod = list.reduce((a,r) => a + Number(r.rodadoAteMomento || 0), 0);
  const totalProj = list.reduce((a,r) => a + Number(r.projFim || 0), 0);
  const saldoAtual = totalContr - totalRod;
  const saldoProj = totalContr - totalProj;

  // Preju√≠zo (R$1 por KM excedido) ‚Äî SOMENTE quando rodado j√° passou do contratado
  const totalExcedenteKm = list.reduce((acc, r) => {
    const rod = Number(r.rodadoAteMomento || 0);
    const ctr = Number(r.kmContratado || 0);
    return acc + Math.max(0, rod - ctr);
  }, 0);
  const totalPrejuizo = totalExcedenteKm; // R$ 1 por km

  // Agrupa por cliente (e j√° acumula excedente por cliente)
  const map = new Map();
  list.forEach(r => {
    const cli = (r.cliente || getCliente(r) || '‚Äî').toString();
    if (!map.has(cli)) map.set(cli, { cliente: cli, contratado: 0, rodado: 0, proj: 0, excedente: 0 });
    const it = map.get(cli);

    it.contratado += Number(r.kmContratado || 0);
    it.rodado += Number(r.rodadoAteMomento || 0);
    it.proj += Number(r.projFim || 0);

    const rod = Number(r.rodadoAteMomento || 0);
    const ctr = Number(r.kmContratado || 0);
    it.excedente += Math.max(0, rod - ctr);
  });

  const clientes = Array.from(map.values())
    .map(it => ({
      ...it,
      saldoAtual: it.contratado - it.rodado,
      saldoProj: it.contratado - it.proj,
      prejuizo: (it.excedente || 0) // R$ 1 por km
    }))
    .sort((a,b) => a.cliente.localeCompare(b.cliente, 'pt-BR'));

  const cards = [];

  // TOTAL
  const clsTotal = cardClass(totalContr, saldoProj);
  cards.push(`
    <div class="mx-client-card ${clsTotal}">
      <div class="mx-client-title">
        <div class="name">TOTAL (FILTROS)</div>
        <span class="pill">${saldoProj < 0 ? 'Pagando p/ trabalhar' : 'Positivo'}</span>
      </div>
      <div class="mx-client-metrics">
        <div class="mx-metric"><div class="k">Contratado</div><div class="v">${fmtKm(totalContr)} km</div></div>
        <div class="mx-metric"><div class="k">Realizado</div><div class="v">${fmtKm(totalRod)} km</div></div>
        <div class="mx-metric"><div class="k">Saldo atual</div><div class="v ${clsSaldo(saldoAtual)}">${fmtKm(saldoAtual)} km</div></div>
        <div class="mx-metric"><div class="k">Saldo proj.</div><div class="v ${clsSaldo(saldoProj)}">${fmtKm(saldoProj)} km</div></div>
        <div class="mx-metric full"><div class="k">Preju√≠zo estimado (R$)</div><div class="v ${totalPrejuizo > 0 ? 'loss' : 'pos'}">R$ ${fmtMoney(totalPrejuizo)}${totalPrejuizo > 0 ? `` : ''}</div></div>
      </div>
    </div>
  `);

  // Por cliente
  clientes.forEach(it => {
    const cls = cardClass(it.contratado, it.saldoProj);
    cards.push(`
      <div class="mx-client-card ${cls}">
        <div class="mx-client-title">
          <div class="name">${it.cliente}</div>
          <span class="pill">${it.saldoProj < 0 ? 'Pagando p/ trabalhar' : 'Positivo'}</span>
        </div>
        <div class="mx-client-metrics">
          <div class="mx-metric"><div class="k">Contratado</div><div class="v">${fmtKm(it.contratado)} km</div></div>
          <div class="mx-metric"><div class="k">Realizado</div><div class="v">${fmtKm(it.rodado)} km</div></div>
          <div class="mx-metric"><div class="k">Saldo atual</div><div class="v ${clsSaldo(it.saldoAtual)}">${fmtKm(it.saldoAtual)} km</div></div>
          <div class="mx-metric"><div class="k">Saldo proj.</div><div class="v ${clsSaldo(it.saldoProj)}">${fmtKm(it.saldoProj)} km</div></div>
          <div class="mx-metric full"><div class="k">Preju√≠zo (R$)</div><div class="v ${it.prejuizo > 0 ? 'loss' : 'pos'}">R$ ${fmtMoney(it.prejuizo)}${it.prejuizo > 0 ? `` : ''}</div></div>
        </div>
      </div>
    `);
  });

  clienteCards.innerHTML = cards.join('');
}

// =======================
// Render da tabela
// =======================
function renderTable(list){
  tbody.innerHTML = "";
  if (!list.length){
    tbody.innerHTML = `<tr><td colspan="10" class="mx-empty">Sem dados para este m√™s (ou filtros atuais).</td></tr>`;
    return;
  }

  list.forEach(r => {
    const b = badgeFor(r.status);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${r.cliente || '‚Äî'}</strong></td>
      <td><strong>${r.equipe}</strong></td>
      <td>${r.kmContratado}</td>
      <td>${r.kmDisponivelDia}</td>
      <td>${r.kmPermitidoAteMomento}</td>
      <td>${r.rodadoAteMomento}</td>
      <td>${r.desvio}</td>
      <td>${r.projFim}</td>
      <td>${r.saldo}</td>
      <td><span class="badge ${b.cls}">${b.text}</span></td>
    `;
    tbody.appendChild(tr);
  });
}


function populateClienteFilter(rows){
  if (!filterCliente) return;
  const current = normalize(filterCliente.value);
  const clientes = Array.from(new Set(rows.map(r => (r.cliente || '').toString().trim()).filter(Boolean)))
    .sort((a,b) => a.localeCompare(b, 'pt-BR'));

  filterCliente.innerHTML = '<option value="">Todos</option>';
  clientes.forEach(c => {
    const opt = document.createElement('option');
    opt.value = normalize(c);
    opt.textContent = c;
    filterCliente.appendChild(opt);
  });

  if (current && clientes.some(c => normalize(c) === current)) filterCliente.value = current;
  else filterCliente.value = '';
}

function populateEquipeFilter(rows, cli){
  if (!filterEquipe) return;
  const current = normalize(filterEquipe.value);

  const scoped = cli ? rows.filter(r => normalize(r.cliente) === cli) : rows;
  const equipes = Array.from(new Set(scoped.map(r => (r.equipe || '').toString().trim()).filter(Boolean)))
    .sort((a,b) => a.localeCompare(b, 'pt-BR'));

  filterEquipe.innerHTML = '<option value="">Todas</option>';
  equipes.forEach(e => {
    const opt = document.createElement('option');
    opt.value = normalize(e);
    opt.textContent = e;
    filterEquipe.appendChild(opt);
  });

  if (current && equipes.some(e => normalize(e) === current)) filterEquipe.value = current;
  else filterEquipe.value = '';
}

function applyFilters(){
  const mes = filterMes.value;
  const st = filterStatus.value;
  const sort = sortBy.value;

  const cli = normalize(filterCliente.value);
  const eq = normalize(filterEquipe.value);

  const monthRows = matrixData
    .filter(r => r.mes === mes)
    .map(calcRow);

  // Atualiza op√ß√µes dos filtros (din√¢mico por m√™s e por cliente)
  populateClienteFilter(monthRows);
  populateEquipeFilter(monthRows, cli);

  const base = monthRows.filter(r => {
    if (cli && normalize(r.cliente) !== cli) return false;
    if (eq && normalize(r.equipe) !== eq) return false;
    if (st && r.status !== st) return false;
    return true;
  });

  base.sort((a,b) => {
    if (sort === "risco_desc") return b.risco - a.risco;
    if (sort === "desvio_desc") return b.desvio - a.desvio;
    if (sort === "rodado_desc") return b.rodadoAteMomento - a.rodadoAteMomento;
    if (sort === "equipe_asc") return a.equipe.localeCompare(b.equipe, "pt-BR");
    return 0;
  });

  mxLastRendered = base;
  updateKpis(base);
  renderClienteCards(base);
  renderTable(base);
}

// ============================== 

// ============================== 
// PDF - Baixar Relat√≥rio (jsPDF + AutoTable) 
// Inclui: KPIs + Resumo por cliente (cards) + tabela
// ============================== 
function formatNow(){
  const d = new Date();
  const pad = (n) => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}

function getKpisFromTela(){
  const num = (id) => {
    const elx = document.getElementById(id);
    const v = elx ? (elx.textContent || '').trim() : '0';
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  };
  return {
    total: num('kpiTotal'),
    excedeu: num('kpiExcedeu'),
    vai: num('kpiVaiExceder'),
    dentro: num('kpiDentro')
  };
}

function drawKpiCards(doc, x0, y0){
  const pageWidth = doc.internal.pageSize.getWidth();
  const gap = 6;
  const cardW = (pageWidth - x0*2 - gap*3) / 4;
  const cardH = 22;

  const k = getKpisFromTela();
  const cards = [
    { label: 'TOTAL DE EQUIPES', value: String(k.total), hint: 'No m√™s selecionado', bar: [149, 165, 166] },
    { label: 'EXCEDEU', value: String(k.excedeu), hint: 'Equipes excedentes', bar: [231, 76, 60] },
    { label: 'VAI EXCEDER', value: String(k.vai), hint: 'Proje√ß√£o final do m√™s', bar: [243, 156, 18] },
    { label: 'DENTRO', value: String(k.dentro), hint: 'Dentro do esperado', bar: [46, 204, 113] }
  ];

  for (let i = 0; i < cards.length; i++){
    const c = cards[i];
    const x = x0 + i * (cardW + gap);

    doc.setDrawColor(230);
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(x, y0, cardW, cardH, 3, 3, 'FD');

    doc.setFillColor(c.bar[0], c.bar[1], c.bar[2]);
    doc.roundedRect(x, y0, 2.6, cardH, 2, 2, 'F');

    doc.setTextColor(90);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.text(c.label, x + 6, y0 + 7);

    doc.setTextColor(20);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.text(c.value, x + 6, y0 + 15);

    doc.setTextColor(120);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.text(c.hint, x + 6, y0 + 20);
  }

  return y0 + cardH;
}

function buildClienteResumo(rows){
  const map = new Map();
  rows.forEach(r => {
    const cli = (r.cliente || '‚Äî').toString();
    if (!map.has(cli)) map.set(cli, { cliente: cli, contratado: 0, rodado: 0, proj: 0 });
    const it = map.get(cli);
    it.contratado += Number(r.kmContratado || 0);
    it.rodado += Number(r.rodadoAteMomento || 0);
    it.proj += Number(r.projFim || 0);
  });

  const list = Array.from(map.values()).map(it => ({
    ...it,
    saldoAtual: it.contratado - it.rodado,
    saldoProj: it.contratado - it.proj
  })).sort((a,b) => a.cliente.localeCompare(b.cliente, 'pt-BR'));

  const totalContr = rows.reduce((a,r) => a + Number(r.kmContratado || 0), 0);
  const totalRod = rows.reduce((a,r) => a + Number(r.rodadoAteMomento || 0), 0);
  const totalProj = rows.reduce((a,r) => a + Number(r.projFim || 0), 0);

  const totalObj = {
    cliente: 'TOTAL (FILTROS)',
    contratado: totalContr,
    rodado: totalRod,
    proj: totalProj,
    saldoAtual: totalContr - totalRod,
    saldoProj: totalContr - totalProj,
    isTotal: true
  };

  return [totalObj, ...list];
}

function fmtKmPdf(n){
  const v = Number(n || 0);
  return v.toLocaleString('pt-BR');
}

function saldoLabel(saldoProj){
  return Number(saldoProj) < 0 ? 'Pagando p/ trabalhar' : 'Positivo';
}

function clientCardStyle(item){
  if (Number(item.saldoProj) < 0) return { bar: [231, 76, 60] };
  const c = Number(item.contratado || 0);
  if (c > 0 && Number(item.saldoProj) <= c * 0.05) return { bar: [243, 156, 18] };
  return { bar: [46, 204, 113] };
}

function drawClienteCards(doc, items, x0, y0){
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const cols = 3;
  const gap = 6;
  const cardW = (pageW - x0*2 - gap*(cols-1)) / cols;
  const cardH = 30;

  let x = x0;
  let y = y0;
  let col = 0;

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(11);
  doc.setTextColor(20);
  doc.text('Resumo por cliente', x0, y0 - 3);
  y += 2;

  for (let i = 0; i < items.length; i++){
    const it = items[i];

    if (y + cardH > pageH - 14){
      doc.addPage();
      x = x0;
      y = 18;
      col = 0;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(20);
      doc.text('Resumo por cliente (cont.)', x0, y - 3);
      y += 2;
    }

    const st = clientCardStyle(it);

    doc.setDrawColor(230);
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(x, y, cardW, cardH, 3, 3, 'FD');

    doc.setFillColor(st.bar[0], st.bar[1], st.bar[2]);
    doc.roundedRect(x, y, 2.6, cardH, 2, 2, 'F');

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    doc.setTextColor(60);
    doc.text((it.cliente || '‚Äî').toString().toUpperCase(), x + 6, y + 7);

    const pill = saldoLabel(it.saldoProj);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(7);
    doc.setTextColor(st.bar[0], st.bar[1], st.bar[2]);
    doc.text(pill, x + cardW - 6 - doc.getTextWidth(pill), y + 7);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(7);
    doc.setTextColor(90);
    doc.text('CONTRATADO', x + 6, y + 14);
    doc.text('REALIZADO', x + cardW/2 + 2, y + 14);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.setTextColor(20);
    doc.text(fmtKmPdf(it.contratado) + ' km', x + 6, y + 19);
    doc.text(fmtKmPdf(it.rodado) + ' km', x + cardW/2 + 2, y + 19);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(7);
    doc.setTextColor(90);
    doc.text('SALDO ATUAL', x + 6, y + 25);
    doc.text('SALDO PROJ.', x + cardW/2 + 2, y + 25);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    const corSaldoA = Number(it.saldoAtual) < 0 ? [231,76,60] : [46,204,113];
    const corSaldoP = Number(it.saldoProj) < 0 ? [231,76,60] : [46,204,113];
    doc.setTextColor(corSaldoA[0], corSaldoA[1], corSaldoA[2]);
    doc.text(fmtKmPdf(it.saldoAtual) + ' km', x + 6, y + 29);
    doc.setTextColor(corSaldoP[0], corSaldoP[1], corSaldoP[2]);
    doc.text(fmtKmPdf(it.saldoProj) + ' km', x + cardW/2 + 2, y + 29);

    col += 1;
    if (col >= cols){
      col = 0;
      x = x0;
      y += cardH + gap;
    }else{
      x += cardW + gap;
    }
  }

  return y + (col === 0 ? 0 : cardH + gap);
}

function gerarPdfRelatorio(){
  if (!window.jsPDF){
    alert('Biblioteca jsPDF n√£o carregou. Verifique sua conex√£o e tente novamente.');
    return;
  }

  const rows = Array.isArray(mxLastRendered) ? mxLastRendered : [];
  if (!rows.length){
    alert('Sem registros para gerar o relat√≥rio. Ajuste os filtros e tente novamente.');
    return;
  }

  const doc = new window.jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
  if (typeof doc.autoTable !== 'function'){
    alert('Plugin AutoTable n√£o carregou. Verifique sua conex√£o e tente novamente.');
    return;
  }

  const mesTxt = getSelectedText(filterMes);
  const statusTxt = filterStatus.value ? getSelectedText(filterStatus) : 'Todos';
  const ordenacaoTxt = getSelectedText(sortBy);
const titulo = 'Relat√≥rio - Matriz de controle mensal (KM)';
  const geradoEm = new Date().toLocaleString('pt-BR');

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(14);
  doc.setTextColor(20);
  doc.text(titulo, 14, 14);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.setTextColor(60);
  doc.text(`Gerado em: ${geradoEm}`, 14, 20);
  const clienteTxt = filterCliente.value ? getSelectedText(filterCliente) : "Todos";
  const equipeTxt = filterEquipe.value ? getSelectedText(filterEquipe) : "Todas";
  doc.text(`Filtros: M√™s: ${mesTxt} ‚Ä¢ Cliente: ${clienteTxt} ‚Ä¢ Equipe: ${equipeTxt} ‚Ä¢ Status: ${statusTxt} ‚Ä¢ Ordena√ß√£o: ${ordenacaoTxt}`, 14, 26);

  let y = drawKpiCards(doc, 14, 30) + 6;

  const resumoClientes = buildClienteResumo(rows);
  y = drawClienteCards(doc, resumoClientes, 14, y + 6);

  const head = [[ 'Cliente','Equipe','KM contratado','KM/dia','Permitido','Rodado','Desvio','Proje√ß√£o','Saldo','Status' ]];
  const body = rows.map(r => {
    const b = badgeFor(r.status);
    return [
      (r.cliente || '‚Äî').toString(),
      (r.equipe || '‚Äî').toString(),
      String(r.kmContratado ?? '‚Äî'),
      String(r.kmDisponivelDia ?? '‚Äî'),
      String(r.kmPermitidoAteMomento ?? '‚Äî'),
      String(r.rodadoAteMomento ?? '‚Äî'),
      String(r.desvio ?? '‚Äî'),
      String(r.projFim ?? '‚Äî'),
      String(r.saldo ?? '‚Äî'),
      (b.text || '‚Äî').toString()
    ];
  });

  doc.autoTable({
    head,
    body,
    startY: y,
    styles: { font: 'helvetica', fontSize: 8, cellPadding: 2, valign: 'top' },
    headStyles: { fillColor: [243, 243, 243], textColor: [34, 34, 34], fontStyle: 'bold' },
    columnStyles: {
      0: { cellWidth: 22 },
      1: { cellWidth: 58 },
      2: { cellWidth: 20 },
      3: { cellWidth: 18 },
      4: { cellWidth: 24 },
      5: { cellWidth: 22 },
      6: { cellWidth: 18 },
      7: { cellWidth: 24 },
      8: { cellWidth: 18 },
      9: { cellWidth: 18 }
    },
    didDrawPage: function(){
      const pageCount = doc.getNumberOfPages();
      const pageInfo = doc.internal.getCurrentPageInfo();
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(`P√°gina ${pageInfo.pageNumber} de ${pageCount}`, pageW - 34, pageH - 8);
    }
  });

  doc.save(`relatorio_matriz_km_${formatNow()}.pdf`);
}



// Eventos
["input","change"].forEach(evt => {
filterMes.addEventListener(evt, applyFilters);
  filterCliente.addEventListener(evt, applyFilters);
  filterEquipe.addEventListener(evt, applyFilters);
  filterStatus.addEventListener(evt, applyFilters);
  sortBy.addEventListener(evt, applyFilters);
});

$("btnLimpar").addEventListener("click", () => {
filterStatus.value = "";
  sortBy.value = "risco_desc";
  applyFilters();
});

$("btnBaixarRelatorio").addEventListener("click", gerarPdfRelatorio);

// Inicializa
setDefaultMes();
applyFilters();

  </script>

</body>
</html>